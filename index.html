<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM DocStudio: Document Workspace</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500;600&family=Manrope:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════
   PM DOCSTUDIO — 2026 DESIGN SYSTEM
   Reference: Dark SaaS Command Center
═══════════════════════════════════════════════ */

:root {
  /* ── Backgrounds ── */
  --bg:         #111318;
  --bg-raised:  #181b22;
  --surface:    #1e2230;
  --surface2:   #242838;
  --surface3:   #2c3248;
  --panel:      #13172000;

  /* ── Glass ── */
  --glass:      rgba(255,255,255,0.055);
  --glass2:     rgba(255,255,255,0.09);
  --glass3:     rgba(255,255,255,0.13);

  /* ── Text ── */
  --text-primary:   #eef0fa;
  --text-secondary: #b4bcdc;
  --text-muted:     #7880a4;
  --text-disabled:  #5a6280;

  /* ── Borders ── */
  --border:    rgba(255,255,255,0.1);
  --border2:   rgba(255,255,255,0.15);
  --border3:   rgba(255,255,255,0.22);

  /* ── Accent (electric indigo) ── */
  --accent:     #6d70f8;
  --accent-lt:  #939cf9;
  --accent-dim: rgba(109,112,248,0.2);
  --accent3:    #c8baff;
  --accent-glow:0 0 20px rgba(109,112,248,0.5);

  /* ── Semantic colors ── */
  --green:      #22c55e;
  --green-dim:  rgba(34,197,94,0.18);
  --amber:      #f59e0b;
  --amber-dim:  rgba(245,158,11,0.18);
  --rose:       #f43f5e;
  --rose-dim:   rgba(244,63,94,0.18);
  --violet:     #a78bfa;
  --violet-dim: rgba(167,139,250,0.18);
  --sky:        #38bdf8;
  --sky-dim:    rgba(56,189,248,0.18);
  --teal:       #2dd4bf;
  --teal-dim:   rgba(45,212,191,0.18);
  --orange:     #fb923c;
  --orange-dim: rgba(251,146,60,0.18);

  /* ── Shadows ── */
  --shadow-sm:  0 1px 6px rgba(0,0,0,0.5);
  --shadow-md:  0 4px 20px rgba(0,0,0,0.55);
  --shadow-lg:  0 12px 40px rgba(0,0,0,0.65);
  --shadow-xl:  0 24px 64px rgba(0,0,0,0.75);

  /* ── Radius ── */
  --r-xs: 6px;
  --r-sm: 8px;
  --r-md: 12px;
  --r-lg: 16px;
  --r-xl: 20px;

  /* ── Sidebar ── */
  --sidebar-w: 260px;
  --nav-h: 56px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--text-primary);
  font-family: 'Inter', -apple-system, sans-serif;
  min-height: 100vh;
  overflow: hidden; /* sidebars fixed, only editor scrolls */
  -webkit-font-smoothing: antialiased;
}

/* ── BACKGROUND ATMOSPHERE ── */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 900px 600px at 0% 0%,   rgba(99,102,241,0.11) 0%, transparent 70%),
    radial-gradient(ellipse 700px 500px at 100% 100%, rgba(167,139,250,0.08) 0%, transparent 70%),
    radial-gradient(ellipse 500px 400px at 50% 100%, rgba(34,197,94,0.04) 0%, transparent 70%);
}
/* Subtle grid lines */
body::after {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image:
    linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
  background-size: 48px 48px;
}


/* ══════════════════════════════════
   TOP NAVIGATION
══════════════════════════════════ */
.nav {
  position: fixed; top: 0; left: 0; right: 0;
  z-index: 500;
  height: var(--nav-h);
  background: rgba(17,19,24,0.94);
  backdrop-filter: blur(20px) saturate(160%);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 0 20px 0 16px;
  gap: 16px;
}

.nav-logo {
  display: flex; align-items: center; gap: 10px;
  flex-shrink: 0;
}
.nav-logo-icon {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
  border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 0 18px rgba(99,102,241,0.45);
  flex-shrink: 0;
}
.nav-logo-text {
  font-family: 'Manrope', sans-serif;
  font-size: 15px; font-weight: 800;
  color: var(--text-primary);
  letter-spacing: -0.025em;
}
.nav-logo-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; font-weight: 500;
  background: var(--accent-dim);
  color: var(--accent-lt);
  border: 1px solid rgba(99,102,241,0.25);
  padding: 2px 7px; border-radius: 100px;
  letter-spacing: 0.04em;
}

.nav-center-label {
  flex: 1;
  font-size: 13px; font-weight: 500;
  color: var(--text-muted);
  text-align: center;
  letter-spacing: 0.01em;
}
.nav-center-label strong {
  color: var(--text-secondary); font-weight: 600;
}

.nav-actions { display: flex; gap: 8px; }

.btn {
  font-family: 'Inter', sans-serif;
  font-size: 13px; font-weight: 600;
  padding: 7px 16px; border-radius: var(--r-sm);
  cursor: pointer; border: none;
  transition: all 0.17s ease;
  display: flex; align-items: center; gap: 7px;
  white-space: nowrap; letter-spacing: 0.01em;
}
.btn svg { flex-shrink: 0; }
.btn-ghost {
  background: var(--glass2);
  color: var(--text-secondary);
  border: 1px solid var(--border2);
}
.btn-ghost:hover {
  background: var(--glass3); color: var(--text-primary);
  border-color: var(--border3);
}
.btn-primary {
  background: var(--accent);
  color: #fff; font-weight: 700;
  box-shadow: 0 0 0 1px rgba(99,102,241,0.5), 0 4px 16px rgba(99,102,241,0.35);
}
.btn-primary:hover {
  background: var(--accent-lt);
  box-shadow: 0 0 0 1px rgba(129,140,248,0.6), 0 4px 24px rgba(99,102,241,0.5);
  transform: translateY(-1px);
}


/* ══════════════════════════════════
   WORKSPACE LAYOUT (fixed sidebars)
══════════════════════════════════ */
.workspace {
  position: fixed;
  top: var(--nav-h); left: 0; right: 0; bottom: 0;
  z-index: 1;
  display: grid;
  grid-template-columns: var(--sidebar-w) 1fr var(--sidebar-w);
  transition: grid-template-columns 0.3s cubic-bezier(0.4,0,0.2,1);
}


/* ══════════════════════════════════
   LEFT SIDEBAR
══════════════════════════════════ */
.sidebar-left {
  background: linear-gradient(180deg, #181c28 0%, #141720 100%);
  border-right: 1px solid rgba(99,102,241,0.15);
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0 0 120px; /* Extra bottom padding for small screens */
  display: flex;
  flex-direction: column;
  height: 100%; /* Ensure it fills the workspace height */
}
.sidebar-left::-webkit-scrollbar { width: 4px; }
.sidebar-left::-webkit-scrollbar-track { background: transparent; }
.sidebar-left::-webkit-scrollbar-thumb {
  background: rgba(99,102,241,0.4);
  border-radius: 2px;
}
.sidebar-left::-webkit-scrollbar-thumb:hover {
  background: rgba(99,102,241,0.6);
}

/* Top accent bar — real element, not pseudo */
.sl-top-bar {
  height: 3px;
  flex-shrink: 0;
  background: linear-gradient(90deg, var(--accent) 0%, #a78bfa 50%, var(--teal) 100%);
  box-shadow: 0 2px 16px rgba(99,102,241,0.4);
}

/* Section wrapper — border-bottom dividers */
.sl-section {
  border-bottom: 1px solid rgba(255,255,255,0.07);
  overflow: hidden;
  flex-shrink: 0; /* CRITICAL: prevent sections from compressing */
}
.sl-section:last-child { border-bottom: none; }

/* Section header */
.sl-collapse-btn {
  width: 100%;
  display: flex; align-items: center; gap: 10px;
  padding: 14px 16px;
  background: none; border: none; cursor: pointer;
  transition: all 0.18s;
  text-align: left;
}
.sl-collapse-btn:hover {
  background: rgba(109,112,248,0.12);
}
.sl-collapse-btn:hover .sl-section-icon {
  background: rgba(109,112,248,0.3); color: var(--accent-lt);
  border-color: rgba(109,112,248,0.45);
  box-shadow: 0 0 16px rgba(109,112,248,0.25);
}
.sl-collapse-btn:hover .sl-section-title { color: var(--text-primary); }

.sl-section-icon {
  width: 26px; height: 26px; border-radius: 7px;
  background: rgba(99,102,241,0.1);
  border: 1px solid rgba(99,102,241,0.2);
  display: flex; align-items: center; justify-content: center;
  color: var(--accent-lt); flex-shrink: 0;
  transition: all 0.2s;
}

.sl-section-title {
  font-family: 'Inter', sans-serif;
  font-size: 10.5px; font-weight: 800;
  color: var(--text-primary);
  text-transform: uppercase; letter-spacing: 0.1em;
  flex: 1; transition: color 0.18s;
}

.sl-chevron {
  color: var(--text-muted);
  transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
  flex-shrink: 0;
}
.sl-section.collapsed .sl-chevron { transform: rotate(-90deg); }

.sl-pct-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; font-weight: 700;
  color: var(--teal);
  background: rgba(45,212,191,0.12);
  border: 1px solid rgba(45,212,191,0.25);
  padding: 2px 8px; border-radius: 100px;
  box-shadow: 0 0 8px rgba(45,212,191,0.15);
}

/* Section body */
.sl-section-body { padding: 4px 12px 16px; }
.sl-section.collapsed .sl-section-body { display: none; }

/* ── DOC TYPE LIST ── */
.doc-type-list { display: flex; flex-direction: column; gap: 3px; }

/* ── ENHANCED INTERACTIVE STATES ── */
.doc-type-item {
  display: flex; align-items: center; gap: 11px;
  padding: 10px 11px; border-radius: var(--r-sm);
  cursor: pointer;
  border: 1px solid transparent;
  position: relative;
  transition: background 0.18s, border-color 0.18s, transform 0.15s, box-shadow 0.18s;
}
.doc-type-item:hover {
  background: rgba(109,112,248,0.1);
  border-color: rgba(109,112,248,0.22);
  transform: translateX(4px);
}
.doc-type-item:hover .doc-type-name { color: var(--text-primary); }
.doc-type-item:hover .doc-type-badge { filter: brightness(1.3) saturate(1.2); }

.doc-type-item.active {
  background: linear-gradient(90deg, rgba(109,112,248,0.25) 0%, rgba(109,112,248,0.08) 100%);
  border-color: rgba(109,112,248,0.45);
  transform: translateX(4px);
}
.doc-type-item.active::before {
  content: '';
  position: absolute; left: 0; top: 18%; bottom: 18%;
  width: 3px; border-radius: 0 3px 3px 0;
  background: linear-gradient(180deg, var(--accent-lt), var(--accent));
  box-shadow: 0 0 12px rgba(109,112,248,0.8), 2px 0 16px rgba(109,112,248,0.4);
}

.doc-type-badge {
  width: 32px; height: 32px; border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  transition: transform 0.18s, box-shadow 0.18s;
}
.badge-green  { background: rgba(34,197,94,0.2);   color: var(--green);  border: 1px solid rgba(34,197,94,0.3); }
.badge-amber  { background: rgba(245,158,11,0.2);  color: var(--amber);  border: 1px solid rgba(245,158,11,0.3); }
.badge-slate  { background: rgba(56,189,248,0.2);  color: var(--sky);    border: 1px solid rgba(56,189,248,0.3); }
.badge-rose   { background: rgba(244,63,94,0.2);   color: var(--rose);   border: 1px solid rgba(244,63,94,0.3); }
.badge-violet { background: rgba(167,139,250,0.2); color: var(--violet); border: 1px solid rgba(167,139,250,0.3); }
.badge-teal   { background: rgba(45,212,191,0.2);  color: var(--teal);   border: 1px solid rgba(45,212,191,0.3); }

.doc-type-item.active .badge-green  { box-shadow: 0 0 16px rgba(34,197,94,0.45); }
.doc-type-item.active .badge-amber  { box-shadow: 0 0 16px rgba(245,158,11,0.45); }
.doc-type-item.active .badge-slate  { box-shadow: 0 0 16px rgba(56,189,248,0.45); }
.doc-type-item.active .badge-rose   { box-shadow: 0 0 16px rgba(244,63,94,0.45); }
.doc-type-item.active .badge-violet { box-shadow: 0 0 16px rgba(167,139,250,0.45); }
.doc-type-item.active .badge-teal   { box-shadow: 0 0 16px rgba(45,212,191,0.45); }

.doc-type-info { flex: 1; min-width: 0; }
.doc-type-name {
  font-size: 13px; font-weight: 600;
  color: var(--text-secondary); line-height: 1.3;
  transition: color 0.15s;
}
.doc-type-sub {
  font-size: 10.5px; color: var(--text-muted);
  margin-top: 2px; line-height: 1.2;
}
.doc-type-item.active .doc-type-name { color: #b4bdff; font-weight: 700; }
.doc-type-item.active .doc-type-sub  { color: var(--text-secondary); }


/* ── PROGRESS ── */
.progress-wrap { padding: 4px 0; }
.progress-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; color: var(--text-secondary);
  margin-bottom: 10px; display: flex; align-items: center;
  justify-content: space-between;
}
.progress-bar-bg {
  height: 6px; background: rgba(255,255,255,0.1);
  border-radius: 100px; overflow: visible;
  position: relative;
}
.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent) 0%, #a78bfa 50%, var(--teal) 100%);
  border-radius: 100px;
  transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
  box-shadow: 0 0 12px rgba(99,102,241,0.6), 0 0 24px rgba(99,102,241,0.3);
  position: relative;
}
.progress-bar-fill::after {
  content: '';
  position: absolute; right: -1px; top: 50%;
  transform: translateY(-50%);
  width: 10px; height: 10px; border-radius: 50%;
  background: white;
  box-shadow: 0 0 6px rgba(99,102,241,0.9), 0 0 14px rgba(99,102,241,0.5);
  display: none;
}
.progress-bar-fill[style*="width: 0"] + .progress-bar-fill::after,
.progress-bar-fill[style*="width:0"]::after { display: none; }


/* ── TIP CARD ── */
.tip-card {
  background: linear-gradient(135deg, rgba(99,102,241,0.11) 0%, rgba(45,212,191,0.06) 100%);
  border: 1px solid rgba(99,102,241,0.22);
  border-radius: var(--r-sm);
  padding: 14px;
  font-size: 11.5px; line-height: 1.75;
  color: var(--text-primary);
  position: relative; overflow: hidden;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.04), 0 4px 16px rgba(99,102,241,0.08);
}
.tip-card::before {
  content: '"';
  position: absolute; top: -4px; left: 8px;
  font-size: 52px; line-height: 1;
  color: rgba(99,102,241,0.18);
  font-family: Georgia, serif;
  pointer-events: none;
}
.tip-card strong { color: var(--accent-lt); font-weight: 700; }


/* ══════════════════════════════════
   CENTER EDITOR (scrollable)
══════════════════════════════════ */
.editor-area {
  overflow-y: auto; overflow-x: hidden;
  padding: 32px 36px 80px;
  background: #181b27;
  position: relative; z-index: 1;
}
.editor-area::-webkit-scrollbar { width: 5px; }
.editor-area::-webkit-scrollbar-track { background: transparent; }
.editor-area::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 10px; }
.editor-area::-webkit-scrollbar-thumb:hover { background: var(--surface2); }


/* ── DOC HEADER ── */
.doc-header { 
  margin-bottom: 28px; 
  animation: fadeUp 0.35s ease both;
  background: #1e2230;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r-lg);
  padding: 22px 22px 18px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.4);
}

.doc-type-tag {
  display: inline-flex; align-items: center; gap: 6px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; font-weight: 500; letter-spacing: 0.1em;
  padding: 4px 12px; border-radius: 100px;
  margin-bottom: 14px;
  border: 1px solid var(--border2); background: var(--glass);
  color: var(--text-muted);
}

.doc-title-input {
  width: 100%;
  font-family: 'Manrope', sans-serif;
  font-size: 30px; font-weight: 800;
  color: var(--text-primary);
  background: transparent;
  border: 2px solid transparent;
  border-bottom: 2px solid rgba(99,102,241,0.2);
  border-radius: 8px 8px 0 0;
  outline: none;
  line-height: 1.2;
  letter-spacing: -0.03em;
  resize: none;
  overflow: hidden;
  min-height: 52px;
  padding: 10px 12px;
  caret-color: var(--accent);
  transition: all 0.2s ease;
}
.doc-title-input::placeholder {
  color: rgba(148,155,196,0.35);
  font-style: italic;
}
.doc-title-input:hover {
  background: linear-gradient(135deg, rgba(99,102,241,0.04) 0%, transparent 100%);
  border-bottom-color: rgba(99,102,241,0.25);
}
.doc-title-input:focus {
  background: linear-gradient(135deg, rgba(99,102,241,0.06) 0%, rgba(99,102,241,0.02) 100%);
  border-color: transparent;
  border-bottom-color: var(--accent);
  box-shadow: 0 4px 0 0 var(--accent), 0 6px 20px rgba(99,102,241,0.15);
  color: #ffffff;
}
.doc-title-input:not(:focus):placeholder-shown {
  border-style: dashed;
  border-bottom-style: dashed;
  border-bottom-color: rgba(99,102,241,0.12);
}

.doc-meta-row {
  display: flex; flex-wrap: wrap; gap: 20px;
  margin-top: 16px; padding-top: 16px;
  border-top: 1px solid var(--border);
}
.meta-field { display: flex; flex-direction: column; gap: 6px; }
.meta-field label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; letter-spacing: 0.2em;
  text-transform: uppercase; color: var(--accent3);
  font-weight: 600;
}
.meta-field input, .meta-field select {
  font-family: 'Inter', sans-serif;
  font-size: 13px; font-weight: 500;
  color: var(--text-primary);
  border: none; background: transparent; outline: none;
  border-bottom: 1.5px solid rgba(255,255,255,0.13);
  padding: 4px 0; min-width: 120px;
  transition: border-color 0.18s;
  caret-color: var(--accent);
}
.meta-field input:focus, .meta-field select:focus { border-color: var(--accent); }
.meta-field input::placeholder { color: var(--text-disabled); }
.meta-field select {
  appearance: none; cursor: pointer;
  color: var(--text-primary);
}
.meta-field select option { background: var(--surface2); color: var(--text-primary); }


/* ── FORM SECTIONS (Accordions) ── */
.form-sections { display: flex; flex-direction: column; gap: 10px; animation: fadeUp 0.4s 0.05s ease both; }

.form-section {
  background: #1e2230;
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: var(--r-md);
  overflow: hidden;
  transition: border-color 0.2s, box-shadow 0.2s;
  box-shadow: 0 2px 10px rgba(0,0,0,0.45), 0 1px 3px rgba(0,0,0,0.3);
}
.form-section:focus-within {
  border-color: rgba(109,112,248,0.5);
  box-shadow: 0 0 0 3px rgba(109,112,248,0.1), 0 4px 20px rgba(0,0,0,0.35);
}

/* Accordion header */
.section-head {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 18px;
  cursor: pointer; user-select: none;
  background: rgba(255,255,255,0.03);
  border-bottom: 1px solid transparent;
  transition: background 0.15s, border-color 0.15s;
}
.section-head:hover { background: rgba(255,255,255,0.055); }
.section-head.open  { border-bottom-color: var(--border); }

.section-head-icon {
  width: 30px; height: 30px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; flex-shrink: 0;
}
.section-head-text { flex: 1; }
.section-head-title { font-size: 13.5px; font-weight: 700; color: #ffffff; line-height: 1; }
.section-head-desc  { font-size: 11px; color: var(--text-secondary); margin-top: 3px; line-height: 1.3; }

.section-required {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; padding: 3px 9px; border-radius: 100px;
  background: var(--amber-dim); color: var(--amber);
  border: 1px solid rgba(245,158,11,0.25); letter-spacing: 0.06em;
}
.section-optional {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; padding: 3px 9px; border-radius: 100px;
  background: var(--glass); color: var(--text-muted);
  border: 1px solid var(--border); letter-spacing: 0.06em;
}

.section-toggle {
  width: 22px; height: 22px; border-radius: 6px;
  background: var(--glass); color: var(--text-muted);
  display: flex; align-items: center; justify-content: center;
  transition: all 0.22s ease; flex-shrink: 0;
}
.section-toggle svg { transition: transform 0.22s ease; }
.section-head.open .section-toggle svg { transform: rotate(180deg); }
.section-body-open .section-toggle svg,
.section-head.open + .section-body .section-toggle svg { transform: rotate(180deg); }

.section-body {
  padding: 20px 18px;
  display: flex; flex-direction: column; gap: 16px;
  animation: fadeUp 0.2s ease both;
  background: rgba(0,0,0,0.12);
}
.section-body.collapsed { display: none; }


/* ── FIELD GROUPS ── */
.field-group { display: flex; flex-direction: column; gap: 8px; }

.field-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9.5px; letter-spacing: 0.18em;
  text-transform: uppercase; color: var(--accent3);
  display: flex; align-items: center; gap: 8px; font-weight: 600;
}
.field-label .req { color: var(--rose); }

.field-input, .field-textarea {
  width: 100%;
  font-family: 'Inter', sans-serif;
  font-size: 14px; font-weight: 400;
  color: var(--text-primary);
  background: #111318;
  border: 1.5px solid rgba(255,255,255,0.11);
  border-radius: var(--r-sm);
  padding: 11px 14px;
  outline: none;
  transition: border-color 0.18s, background 0.18s, box-shadow 0.18s;
  line-height: 1.55;
  caret-color: var(--accent);
}
.field-textarea { resize: vertical; min-height: 90px; }
.field-input:focus, .field-textarea:focus {
  border-color: var(--accent);
  background: #0f1119;
  box-shadow: 0 0 0 3px rgba(109,112,248,0.15), 0 2px 12px rgba(0,0,0,0.35);
}
.field-input:hover:not(:focus), .field-textarea:hover:not(:focus) {
  border-color: rgba(255,255,255,0.18);
  background: #131621;
}
.field-input::placeholder, .field-textarea::placeholder { color: var(--text-disabled); }
.field-hint {
  font-size: 11px; color: var(--text-muted); line-height: 1.55; font-style: italic;
}


/* ── TWO-COL ── */
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }


/* ── STORY ROWS ── */
.story-rows { display: flex; flex-direction: column; gap: 8px; }
.story-row {
  display: grid;
  grid-template-columns: 1fr auto 1fr auto 1fr auto;
  gap: 0;
  align-items: stretch;
  background: #111318;
  border: 1.5px solid rgba(255,255,255,0.11);
  border-radius: var(--r-sm);
  overflow: hidden;
  transition: border-color 0.15s, box-shadow 0.15s;
  min-height: 48px;
}
.story-row:focus-within { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(109,112,248,0.15); }
.story-row:hover { border-color: rgba(255,255,255,0.18); }
.story-connector {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; color: var(--text-disabled);
  white-space: nowrap; padding: 0 10px;
  background: var(--glass); border-left: 1px solid var(--border); border-right: 1px solid var(--border);
  height: 100%; display: flex; align-items: center; justify-content: center;
  letter-spacing: 0.08em; text-transform: uppercase;
}
.story-row input {
  font-family: 'Inter', sans-serif;
  font-size: 13px; font-weight: 400; color: var(--text-primary);
  border: none; background: transparent; outline: none; width: 100%;
  padding: 11px 12px; caret-color: var(--accent);
}
.story-row input::placeholder { color: var(--text-disabled); }

.add-row-btn {
  display: flex; align-items: center; gap: 7px;
  font-size: 12.5px; font-weight: 600; color: var(--accent-lt);
  background: none; border: 1px dashed rgba(99,102,241,0.28);
  border-radius: var(--r-sm); padding: 9px 14px; cursor: pointer;
  transition: all 0.16s; font-family: 'Inter', sans-serif;
  letter-spacing: 0.01em;
}
.add-row-btn:hover {
  background: var(--accent-dim); border-color: var(--accent);
  border-style: solid;
}

.remove-row-btn {
  background: none;
  border: none;
  color: var(--text-disabled);
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  padding: 0 10px;
  transition: all 0.18s;
  display: flex;
  align-items: center;
  justify-content: center;
  align-self: stretch;
  min-width: 36px;
}
.remove-row-btn:hover {
  color: var(--rose);
  background: rgba(244,63,94,0.08);
}


/* ── PRIORITY PILLS ── */
.priority-pills { display: flex; gap: 6px; flex-wrap: wrap; }
.priority-pill {
  padding: 6px 16px; border-radius: 100px;
  border: 1px solid var(--border2);
  font-size: 12px; font-weight: 600; cursor: pointer;
  transition: all 0.16s; background: var(--glass); color: var(--text-muted);
  font-family: 'Inter', sans-serif;
}
.priority-pill:hover { border-color: var(--border3); color: var(--text-secondary); }
.priority-pill.sel-p0 { background: var(--rose-dim);   border-color: rgba(244,63,94,0.4);    color: var(--rose);   box-shadow: 0 0 14px rgba(244,63,94,0.18); }
.priority-pill.sel-p1 { background: var(--amber-dim);  border-color: rgba(245,158,11,0.4);   color: var(--amber);  box-shadow: 0 0 14px rgba(245,158,11,0.18); }
.priority-pill.sel-p2 { background: var(--green-dim);  border-color: rgba(34,197,94,0.4);    color: var(--green);  box-shadow: 0 0 14px rgba(34,197,94,0.18); }
.priority-pill.sel-p3 {
  background: linear-gradient(135deg, rgba(99,102,241,0.12) 0%, rgba(167,139,250,0.08) 100%);
  border-color: rgba(99,102,241,0.35);
  color: var(--accent-lt);
  box-shadow: 0 0 14px rgba(99,102,241,0.15), inset 0 1px 0 rgba(255,255,255,0.05);
}


/* ── SPRINT TABLE ── */
.sprint-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.sprint-table th {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; letter-spacing: 0.18em; text-transform: uppercase;
  color: var(--text-muted); text-align: left;
  padding: 8px 10px; border-bottom: 1px solid var(--border); font-weight: 500;
}
.sprint-table td { padding: 9px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.sprint-table td input, .sprint-table td select {
  font-family: 'Inter', sans-serif;
  font-size: 13px; color: var(--text-primary);
  border: none; background: transparent; outline: none; width: 100%;
  caret-color: var(--accent);
}
.sprint-table td input::placeholder { color: var(--text-disabled); }
.sprint-table td select option { background: var(--surface2); color: var(--text-primary); }
.sprint-table tr:hover td { background: var(--glass); }

.status-badge { display: inline-block; padding: 3px 9px; border-radius: 100px; font-size: 10.5px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
.status-todo       { background: var(--surface3); color: var(--text-muted); }
.status-inprogress { background: var(--sky-dim);  color: var(--sky); }
.status-done       { background: var(--green-dim);color: var(--green); }


/* ══════════════════════════════════
   RIGHT SIDEBAR (Preview + Export)
══════════════════════════════════ */
.sidebar-right {
  background: linear-gradient(180deg, #171924 0%, #111318 100%);
  border-left: 1px solid rgba(99,102,241,0.12);
  display: flex; flex-direction: column; overflow: hidden;
}

/* Right panel accent strip at top */
.sidebar-right::before {
  content: '';
  display: block; height: 2px; width: 100%;
  background: linear-gradient(90deg, transparent, var(--accent), var(--teal));
  opacity: 0.7; flex-shrink: 0;
}

/* ── PREVIEW HEADER — vivid, prominent ── */
.preview-header {
  padding: 0 16px 0;
  flex-shrink: 0;
  background: transparent;
}

/* The main header card with bold LIVE PREVIEW title */
.preview-header-card {
  margin: 14px 0 12px;
  background: linear-gradient(135deg, rgba(99,102,241,0.18) 0%, rgba(45,212,191,0.08) 100%);
  border: 1px solid rgba(99,102,241,0.3);
  border-radius: var(--r-md);
  padding: 13px 14px;
  display: flex; align-items: center; gap: 12px;
  box-shadow: 0 0 24px rgba(99,102,241,0.12), inset 0 1px 0 rgba(255,255,255,0.06);
}

.preview-header-icon {
  width: 36px; height: 36px; border-radius: 10px;
  background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 0 16px rgba(99,102,241,0.5), 0 2px 8px rgba(0,0,0,0.4);
}

.preview-header-info { flex: 1; min-width: 0; }
.preview-header-label {
  font-family: 'Manrope', sans-serif;
  font-size: 12px; font-weight: 800;
  color: var(--text-primary);
  letter-spacing: -0.01em; line-height: 1.2;
}
.preview-header-sub {
  display: flex; align-items: center; gap: 6px;
  margin-top: 3px;
}

/* "LIVE" pill badge */
.live-pill {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(34,197,94,0.15);
  border: 1px solid rgba(34,197,94,0.3);
  border-radius: 100px; padding: 2px 8px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 8.5px; font-weight: 700; letter-spacing: 0.1em;
  color: var(--green); text-transform: uppercase;
}
.live-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 6px rgba(34,197,94,0.9);
  animation: livePulse 1.8s ease-in-out infinite;
  flex-shrink: 0;
}
@keyframes livePulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50%       { opacity: 0.4; transform: scale(0.7); }
}

/* "auto-updates" compact tag */
.auto-tag {
  font-family: 'JetBrains Mono', monospace;
  font-size: 8px; font-weight: 500; letter-spacing: 0.06em;
  color: var(--text-muted);
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 4px; padding: 1px 6px;
}

/* Divider below header card */
.preview-header-divider {
  height: 1px;
  background: linear-gradient(90deg, rgba(99,102,241,0.3), rgba(45,212,191,0.15), transparent);
  margin-bottom: 0;
}

/* ── PREVIEW BODY ── */
.preview-body {
  flex: 1; overflow-y: auto; padding: 12px 14px;
}
.preview-body::-webkit-scrollbar { width: 3px; }
.preview-body::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.2); border-radius: 2px; }

.preview-doc {
  background: rgba(30,34,48,0.85);
  border: 1px solid rgba(109,112,248,0.2);
  border-radius: var(--r-md);
  padding: 18px 16px;
  font-family: 'Inter', sans-serif;
  font-size: 12px; color: var(--text-primary);
  line-height: 1.8; min-height: 260px;
  white-space: pre-wrap; word-break: break-word;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
}

/* Empty state — centered, visible */
.preview-empty {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 40px 16px; text-align: center; gap: 12px;
  min-height: 200px;
}
.preview-empty-icon {
  width: 44px; height: 44px; border-radius: 12px;
  background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.2);
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 4px;
}
.preview-empty-text {
  font-size: 12px; color: var(--text-muted); line-height: 1.6; font-style: italic;
}
.preview-empty-hint {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9.5px; color: var(--text-disabled); letter-spacing: 0.06em;
}

.preview-title-area {
  font-family: 'Manrope', sans-serif;
  font-size: 14px; font-weight: 800;
  color: var(--text-primary); margin-bottom: 14px; line-height: 1.3;
  letter-spacing: -0.02em; padding-bottom: 12px;
  border-bottom: 1px solid rgba(99,102,241,0.12);
}
.preview-section { margin-bottom: 14px; }
.preview-section-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 8px; letter-spacing: 0.22em; text-transform: uppercase;
  color: var(--accent-lt); margin-bottom: 5px;
  display: flex; align-items: center; gap: 6px; opacity: 0.8;
}
.preview-section-title::before {
  content: '';
  width: 3px; height: 10px; border-radius: 2px;
  background: linear-gradient(180deg, var(--accent-lt), var(--accent));
  display: inline-block;
  box-shadow: 0 0 8px rgba(99,102,241,0.6);
}
.preview-section-body {
  font-size: 11.5px; color: var(--text-secondary); line-height: 1.75;
}


/* ── EXPORT FOOTER ── */
.export-footer {
  padding: 12px 14px 16px;
  border-top: 1px solid rgba(99,102,241,0.12);
  display: flex; flex-direction: column; gap: 8px;
  flex-shrink: 0;
  background: rgba(20,23,32,0.98);
}

/* Primary export CTA */
.cta-export-btn {
  width: 100%;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 12px 18px; border-radius: var(--r-sm);
  background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
  color: #fff; font-size: 13px; font-weight: 700;
  font-family: 'Inter', sans-serif;
  border: none; cursor: pointer; letter-spacing: 0.02em;
  box-shadow: 0 0 0 1px rgba(99,102,241,0.4), 0 4px 24px rgba(99,102,241,0.45);
  transition: all 0.2s ease; position: relative; overflow: hidden;
}
.cta-export-btn::after {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 60%);
  border-radius: inherit;
}
.cta-export-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 0 1px rgba(129,140,248,0.5), 0 8px 32px rgba(99,102,241,0.6);
  filter: brightness(1.1);
}
.cta-export-btn:active { transform: translateY(0); }

/* Secondary copy CTA */
.cta-copy-btn {
  width: 100%;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 10px 18px; border-radius: var(--r-sm);
  background: rgba(99,102,241,0.08);
  color: var(--accent-lt); font-size: 13px; font-weight: 600;
  font-family: 'Inter', sans-serif;
  border: 1px solid rgba(99,102,241,0.22); cursor: pointer; letter-spacing: 0.01em;
  transition: all 0.18s ease;
}
.cta-copy-btn:hover {
  background: rgba(99,102,241,0.15);
  border-color: rgba(99,102,241,0.45);
  color: #fff;
  box-shadow: 0 2px 16px rgba(99,102,241,0.25);
  transform: translateY(-1px);
}
.cta-copy-btn:active { transform: translateY(0); }
.cta-copy-btn:hover {
  background: var(--glass3); color: var(--text-primary);
  border-color: var(--border3);
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
  transform: translateY(-1px);
}


/* ══════════════════════════════════
   EXPORT MODAL
══════════════════════════════════ */
.export-modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(12px);
  z-index: 5000;
  display: flex; align-items: center; justify-content: center;
  animation: fadeIn 0.15s ease;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

.export-modal {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: var(--r-xl);
  padding: 26px 26px 22px;
  width: 500px; max-width: 94vw;
  box-shadow: var(--shadow-xl), 0 0 60px rgba(99,102,241,0.1);
  animation: scaleIn 0.2s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes scaleIn { from{opacity:0;transform:scale(0.95) translateY(10px)} to{opacity:1;transform:scale(1) translateY(0)} }

.modal-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:20px; }
.modal-title { font-family:'Manrope',sans-serif; font-size:18px; font-weight:800; color:var(--text-primary); line-height:1.2; letter-spacing:-0.02em; }
.modal-subtitle { font-size:12px; color:var(--text-muted); margin-top:4px; }
.modal-close {
  background:var(--glass2); border:1px solid var(--border); border-radius:var(--r-xs);
  width:28px; height:28px; cursor:pointer; font-size:13px; color:var(--text-muted);
  display:flex; align-items:center; justify-content:center; transition:all 0.15s; flex-shrink:0; margin-left:12px;
}
.modal-close:hover { background:var(--rose-dim); color:var(--rose); border-color:rgba(244,63,94,0.3); }

.modal-section-label {
  font-family:'JetBrains Mono',monospace; font-size:9px; letter-spacing:0.2em; text-transform:uppercase;
  color:var(--text-muted); margin-bottom:10px;
  display:flex; align-items:center; gap:7px;
}
.modal-section-label::after { content:''; flex:1; height:1px; background:var(--border); }

.modal-btn-grid { display:grid; gap:8px; margin-bottom:16px; }
.modal-btn-grid.g2 { grid-template-columns:1fr 1fr; }
.modal-btn-grid.g3 { grid-template-columns:1fr 1fr 1fr; }
.modal-btn-grid.g1 { grid-template-columns:1fr; }

.modal-export-btn {
  display:flex; align-items:center; gap:10px;
  padding:12px 14px; border-radius:var(--r-md);
  border:1px solid var(--border); background:var(--surface2);
  cursor:pointer; transition:all 0.16s; text-align:left;
}
.modal-export-btn:hover {
  border-color:var(--border3); background:var(--surface3);
  transform:translateY(-1px); box-shadow:var(--shadow-md);
}
.modal-export-btn.primary-action { border-color:rgba(99,102,241,0.3); background:var(--accent-dim); }
.modal-export-btn.primary-action:hover { background:rgba(99,102,241,0.22); border-color:var(--accent); box-shadow:0 0 20px rgba(99,102,241,0.15); }

.meb-icon { width:36px; height:36px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:17px; flex-shrink:0; }
.meb-text { flex:1; min-width:0; }
.meb-name { font-size:13px; font-weight:600; color:var(--text-secondary); line-height:1.2; }
.meb-desc { font-size:10.5px; color:var(--text-muted); margin-top:2px; line-height:1.3; }
.meb-badge { font-family:'JetBrains Mono',monospace; font-size:8.5px; letter-spacing:0.06em; padding:2px 8px; border-radius:100px; flex-shrink:0; }
.meb-badge.download { background:var(--green-dim); color:var(--green); border:1px solid rgba(34,197,94,0.2); }
.meb-badge.open     { background:var(--sky-dim);   color:var(--sky);   border:1px solid rgba(56,189,248,0.2); }
.meb-badge.copy     { background:var(--amber-dim); color:var(--amber); border:1px solid rgba(245,158,11,0.2); }


/* ══════════════════════════════════
   GANTT
══════════════════════════════════ */
.gantt-canvas-wrap {
  overflow-x: auto; padding: 16px;
  background: var(--surface);
}
.gantt-canvas-wrap::-webkit-scrollbar { height: 4px; }
.gantt-canvas-wrap::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

.gantt-table { border-collapse: collapse; min-width: 900px; width: 100%; }
.gantt-table th {
  font-family: 'JetBrains Mono', monospace; font-size: 8.5px;
  letter-spacing: 0.16em; text-transform: uppercase; color: var(--text-muted);
  font-weight: 500; padding: 6px 10px; border-bottom: 1px solid var(--border); white-space: nowrap; text-align: left;
}
.gantt-week-header { text-align:center !important; font-size:8px; color:var(--text-disabled); padding:6px 2px !important; border-left:1px solid var(--border); }
.gantt-row { transition: background 0.13s; }
.gantt-row:hover { background: var(--glass); }
.gantt-cell-task { padding:10px 12px; min-width:160px; border-bottom:1px solid var(--border); }
.gantt-task-name { font-size:12.5px; font-weight:600; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px; }
.gantt-task-owner { font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-muted); margin-top:2px; }
.gantt-cell-meta  { padding:10px 10px; border-bottom:1px solid var(--border); white-space:nowrap; vertical-align:middle; }
.gantt-cell-week  { padding:8px 2px; border-left:1px solid var(--border); border-bottom:1px solid var(--border); min-width:26px; vertical-align:middle; }
.gantt-today-line { position:relative; }
.gantt-today-line::after { content:''; position:absolute; top:0; bottom:0; left:50%; width:2px; background:var(--rose); opacity:0.6; border-radius:1px; box-shadow:0 0 6px rgba(244,63,94,0.4); }

.gstatus {
  display:inline-block; font-family:'JetBrains Mono',monospace;
  font-size:9px; letter-spacing:0.06em; padding:3px 8px;
  border-radius:100px; font-weight:500; text-transform:uppercase;
}
.gstatus-notstarted { background:var(--surface3); color:var(--text-muted); }
.gstatus-inprogress { background:var(--sky-dim);   color:var(--sky);   border:1px solid rgba(56,189,248,0.2); }
.gstatus-done       { background:var(--green-dim); color:var(--green); border:1px solid rgba(34,197,94,0.2); }
.gstatus-atrisk     { background:var(--rose-dim);  color:var(--rose);  border:1px solid rgba(244,63,94,0.2); }
.gstatus-blocked    { background:var(--amber-dim); color:var(--amber); border:1px solid rgba(245,158,11,0.2); }

.gantt-editor-row {
  display:grid; grid-template-columns:2fr 1fr 1fr 1fr 1fr 80px auto;
  gap:8px; align-items:center; padding:10px 14px;
  background:var(--surface2); border:1px solid var(--border);
  border-radius:var(--r-sm); margin-bottom:6px; transition:border-color 0.15s;
}
.gantt-editor-row:focus-within { border-color:var(--accent); box-shadow:0 0 0 2px rgba(99,102,241,0.1); }
.gantt-editor-row input, .gantt-editor-row select {
  font-family:'Inter',sans-serif; font-size:12.5px; color:var(--text-primary);
  border:1px solid var(--border2); border-radius:var(--r-xs); padding:6px 10px;
  background:var(--surface); outline:none; width:100%; transition:border-color 0.15s;
  caret-color:var(--accent);
}
.gantt-editor-row input:focus, .gantt-editor-row select:focus { border-color:var(--accent); }
.gantt-editor-row input::placeholder { color:var(--text-disabled); }
.gantt-editor-row select option { background:var(--surface2); color:var(--text-primary); }

.gantt-legend { display:flex; flex-wrap:wrap; gap:10px; padding:12px 18px; border-top:1px solid var(--border); background:var(--bg-raised); }
.gantt-legend-item { display:flex; align-items:center; gap:6px; font-size:11px; color:var(--text-muted); }

.gantt-workspace { display:flex; flex-direction:column; background:var(--surface); border:1px solid var(--border); border-radius:var(--r-lg); overflow:hidden; }

.gantt-section-label {
  font-family:'JetBrains Mono',monospace; font-size:9px; letter-spacing:0.2em; text-transform:uppercase;
  color:var(--text-muted); margin-bottom:10px; display:flex; align-items:center; gap:8px;
}
.gantt-section-label::after { content:''; flex:1; height:1px; background:var(--border); }

/* Gantt export bar */
.gantt-export-bar {
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  padding:14px 20px; border-top:1px solid var(--border); background:var(--bg-raised); flex-shrink:0;
}
.gantt-export-label { font-family:'JetBrains Mono',monospace; font-size:9px; letter-spacing:0.2em; text-transform:uppercase; color:var(--text-muted); margin-right:4px; white-space:nowrap; }
.gantt-xbtn {
  font-family:'Inter',sans-serif; font-size:12px; font-weight:700;
  padding:8px 15px; border-radius:var(--r-sm); cursor:pointer;
  white-space:nowrap; display:flex; align-items:center; gap:6px;
  transition:all 0.15s; border:1px solid transparent; letter-spacing:0.01em;
}
.gantt-xbtn.x-primary { background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 0 14px rgba(99,102,241,0.35); }
.gantt-xbtn.x-primary:hover { background:var(--accent-lt); transform:translateY(-1px); box-shadow:0 0 22px rgba(99,102,241,0.5); }
.gantt-xbtn.x-pdf  { background:var(--rose-dim);  color:var(--rose);  border-color:rgba(244,63,94,0.3); }
.gantt-xbtn.x-pdf:hover  { background:var(--rose);  color:#fff; transform:translateY(-1px); }
.gantt-xbtn.x-csv  { background:var(--green-dim); color:var(--green); border-color:rgba(34,197,94,0.3); }
.gantt-xbtn.x-csv:hover  { background:var(--green); color:#0a1a0f; transform:translateY(-1px); }
.gantt-xbtn.x-json { background:var(--teal-dim);  color:var(--teal);  border-color:rgba(45,212,191,0.3); }
.gantt-xbtn.x-json:hover { background:var(--teal); color:#0a1a18; transform:translateY(-1px); }
.gantt-xbtn.x-copy { background:var(--glass2); color:var(--text-secondary); border-color:var(--border2); margin-left:auto; }
.gantt-xbtn.x-copy:hover { background:var(--glass3); color:var(--text-primary); transform:translateY(-1px); }

/* Gantt mode */
.gantt-mode .sidebar-right { display:none; }
.gantt-mode .workspace { grid-template-columns: var(--sidebar-w) 1fr !important; }


/* ══════════════════════════════════
   MISC
══════════════════════════════════ */
.acceptance-row { display:grid; grid-template-columns:26px 1fr; gap:10px; align-items:start; }
.ac-num {
  width:22px; height:22px; border-radius:6px;
  background:var(--accent-dim); color:var(--accent-lt);
  font-family:'JetBrains Mono',monospace; font-size:10px; font-weight:600;
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0; margin-top:10px; border:1px solid rgba(99,102,241,0.2);
}

.roadmap-item {
  background:var(--surface2); border:1px solid var(--border);
  border-radius:var(--r-md); padding:14px;
  display:grid; grid-template-columns:1fr auto;
  gap:10px; align-items:start;
  transition:border-color 0.15s;
}
.roadmap-item:focus-within { border-color:rgba(99,102,241,0.35); }
.roadmap-item-fields { display:flex; flex-direction:column; gap:8px; }
.roadmap-quarter-label { font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-muted); letter-spacing:0.1em; }
.roadmap-item-input { font-family:'Inter',sans-serif; font-size:13px; color:var(--text-primary); border:none; background:transparent; outline:none; width:100%; caret-color:var(--accent); }
.roadmap-item-input::placeholder { color:var(--text-disabled); }


/* ── TOAST ── */
.toast {
  position:fixed; bottom:24px; right:24px;
  background:var(--surface2); border:1px solid var(--border2);
  color:var(--text-primary); padding:12px 20px;
  border-radius:var(--r-md); font-size:13px; font-weight:500;
  font-family:'Inter',sans-serif;
  box-shadow:var(--shadow-lg), 0 0 24px rgba(99,102,241,0.12);
  z-index:9999;
  transform:translateY(80px); opacity:0;
  transition:all 0.32s cubic-bezier(0.34,1.56,0.64,1);
  display:flex; align-items:center; gap:10px; max-width:320px;
}
.toast::before { content:''; width:6px; height:6px; border-radius:50%; background:var(--accent); box-shadow:0 0 8px rgba(99,102,241,0.9); flex-shrink:0; }
.toast.show { transform:translateY(0); opacity:1; }


/* ── ANIMATIONS ── */
@keyframes fadeUp {
  from { opacity:0; transform:translateY(12px); }
  to   { opacity:1; transform:translateY(0); }
}
.form-sections .form-section:nth-child(1) { animation:fadeUp 0.3s 0.00s ease both; }
.form-sections .form-section:nth-child(2) { animation:fadeUp 0.3s 0.05s ease both; }
.form-sections .form-section:nth-child(3) { animation:fadeUp 0.3s 0.10s ease both; }
.form-sections .form-section:nth-child(4) { animation:fadeUp 0.3s 0.15s ease both; }
.form-sections .form-section:nth-child(5) { animation:fadeUp 0.3s 0.20s ease both; }
.form-sections .form-section:nth-child(6) { animation:fadeUp 0.3s 0.24s ease both; }

/* Sidebar left also fixed height */
.sidebar-label { font-family:'JetBrains Mono',monospace; font-size:9px; letter-spacing:0.2em; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px; padding-left:4px; }
/* Keep old ref for JS */
.export-section-title { display:none; }
.export-btn { display:none; }
.nav-tabs { display:none; }
.check-circle { width:20px; height:20px; border-radius:50%; background:var(--green-dim); color:var(--green); font-family:'JetBrains Mono',monospace; font-size:10px; font-weight:500; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:10px; }

/* ══════════════════════════════════
   BURGER MENU — Left Sidebar Toggle
══════════════════════════════════ */
.burger-btn {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: var(--r-sm);
  background: rgba(99,102,241,0.12);
  border: 1px solid rgba(99,102,241,0.28);
  cursor: pointer; flex-shrink: 0;
  transition: all 0.18s ease;
  color: var(--accent-lt);
  box-shadow: 0 0 10px rgba(99,102,241,0.12);
}
.burger-btn:hover {
  background: rgba(99,102,241,0.22);
  color: #fff;
  border-color: rgba(99,102,241,0.5);
  box-shadow: 0 0 16px rgba(99,102,241,0.28);
}
/* The icon lines never morph — always hamburger */
.burger-btn svg { display: block; }

/* Visual divider between burger and logo */
.nav-divider {
  width: 1px; height: 22px;
  background: linear-gradient(180deg, transparent, rgba(255,255,255,0.15), transparent);
  flex-shrink: 0;
  margin: 0 4px;
}

/* Left sidebar slide */
.sidebar-left {
  transition: width 0.3s cubic-bezier(0.4,0,0.2,1),
              opacity 0.25s ease,
              transform 0.3s cubic-bezier(0.4,0,0.2,1);
  transform-origin: left center;
}
.sidebar-left.collapsed {
  width: 0 !important;
  opacity: 0;
  overflow: hidden;
  pointer-events: none;
}
/* Workspace grid adapts via JS inline style */

/* ══════════════════════════════════
   RIGHT SIDEBAR COLLAPSE TOGGLE
══════════════════════════════════ */

/* The toggle tab lives OUTSIDE sidebar-right, fixed to the viewport right edge */
.right-toggle-tab {
  position: fixed;
  top: 50%;
  right: 0;
  transform: translateY(-50%);
  z-index: 400;
  width: 22px;
  height: 56px;
  background: linear-gradient(180deg, rgba(99,102,241,0.25) 0%, rgba(99,102,241,0.15) 100%);
  border: 1px solid rgba(99,102,241,0.4);
  border-right: none;
  border-radius: 8px 0 0 8px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  color: var(--accent-lt);
  box-shadow: -3px 0 16px rgba(99,102,241,0.2);
  transition: right 0.3s cubic-bezier(0.4,0,0.2,1), background 0.18s ease,
              box-shadow 0.18s ease, width 0.18s ease;
}
.right-toggle-tab:hover {
  background: linear-gradient(180deg, rgba(99,102,241,0.45) 0%, rgba(99,102,241,0.3) 100%);
  color: #fff;
  box-shadow: -4px 0 24px rgba(99,102,241,0.4);
  width: 26px;
}
.right-toggle-tab svg {
  flex-shrink: 0;
  transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
}
/* When panel is open, shift tab left by sidebar width */
.right-toggle-tab.panel-open {
  right: var(--sidebar-w);
}
/* When panel is closed, tab pins to right:0 — always visible, highlighted */
.right-toggle-tab.panel-closed {
  right: 0;
  background: linear-gradient(180deg, rgba(99,102,241,0.4) 0%, rgba(99,102,241,0.28) 100%);
  border-color: rgba(99,102,241,0.6);
  box-shadow: -4px 0 20px rgba(99,102,241,0.4), 0 0 0 1px rgba(99,102,241,0.15);
  color: #fff;
}

.sidebar-right {
  position: relative;
  overflow: hidden;
  transition: width 0.3s cubic-bezier(0.4,0,0.2,1),
              opacity 0.25s ease;
}
.sidebar-right.collapsed {
  width: 0 !important;
  opacity: 0;
  pointer-events: none;
  border: none;
}

/* ══════════════════════════════════════════════════════════════
   BODY VISIBILITY SYSTEM — Dark Theme Typography & Input Design
   Hierarchy: Section Labels > Field Labels > Meta Labels > Hints
   Design Goal: Crystal-clear input affordances + visual hierarchy
══════════════════════════════════════════════════════════════ */

/* ── 1. DOC TYPE TAG (top pill: "📝 USER STORY") ── */
.doc-type-tag {
  font-family: 'Manrope', sans-serif !important;
  font-size: 11px !important;
  font-weight: 700 !important;
  letter-spacing: 0.08em !important;
  color: #e0e7ff !important;
  background: rgba(99,102,241,0.18) !important;
  border: 1px solid rgba(99,102,241,0.35) !important;
  padding: 5px 14px !important;
}

/* ── 2. DOC TITLE (big h1 input) ── */
.doc-title-input {
  font-size: 32px !important;
  background: linear-gradient(135deg, rgba(99,102,241,0.03) 0%, transparent 100%) !important;
  border-bottom-color: rgba(99,102,241,0.18) !important;
  padding: 10px 12px !important;
}
.doc-title-input::placeholder {
  color: rgba(148,155,196,0.35) !important;
}
.doc-title-input:hover {
  background: linear-gradient(135deg, rgba(99,102,241,0.05) 0%, transparent 100%) !important;
  border-bottom-color: rgba(99,102,241,0.28) !important;
}
.doc-title-input:focus {
  color: #ffffff !important;
  background: linear-gradient(135deg, rgba(99,102,241,0.07) 0%, rgba(99,102,241,0.03) 100%) !important;
  border-bottom-color: var(--accent) !important;
  box-shadow: 0 4px 0 0 var(--accent), 0 6px 20px rgba(99,102,241,0.18) !important;
}
.doc-title-input:not(:focus):placeholder-shown {
  border-bottom-style: dashed !important;
  border-bottom-color: rgba(99,102,241,0.12) !important;
}

/* ── 3. META ROW LABELS (Author / Epic / Sprint / Status) ── */
.meta-field {
  position: relative !important;
}
.meta-field label {
  font-family: 'Manrope', sans-serif !important;
  font-size: 10.5px !important;
  font-weight: 700 !important;
  letter-spacing: 0.1em !important;
  text-transform: uppercase !important;
  color: #a5b4fc !important;
  margin-bottom: 4px !important;
  display: block !important;
}

/* Meta inputs — underline style with glow on focus */
.meta-field input,
.meta-field select {
  font-family: 'Inter', sans-serif !important;
  font-size: 13.5px !important;
  font-weight: 500 !important;
  color: #edf0ff !important;
  background: linear-gradient(180deg, transparent 0%, rgba(99,102,241,0.03) 100%) !important;
  border: none !important;
  border-bottom: 2px solid rgba(99,102,241,0.25) !important;
  padding: 6px 4px !important;
  min-width: 130px !important;
  border-radius: 3px 3px 0 0 !important;
  transition: all 0.2s !important;
}
.meta-field input:hover,
.meta-field select:hover {
  background: linear-gradient(180deg, transparent 0%, rgba(99,102,241,0.06) 100%) !important;
  border-bottom-color: rgba(99,102,241,0.4) !important;
}
.meta-field input:focus,
.meta-field select:focus {
  border-bottom-color: #818cf8 !important;
  background: linear-gradient(180deg, transparent 0%, rgba(99,102,241,0.08) 100%) !important;
  outline: none !important;
  box-shadow: 0 1px 0 0 #818cf8, 0 3px 8px rgba(99,102,241,0.15) !important;
  color: #ffffff !important;
}
.meta-field input::placeholder {
  color: rgba(148,163,184,0.4) !important;
  font-style: italic !important;
}
.meta-field select option { background: #1c2030; color: #e8ecff; }
}
.gantt-editor-row select option { background: #1c2030; color: #edf0ff; }

/* ── 13. SECTION BODY divider line color ── */
.section-head.open {
  border-bottom-color: rgba(255,255,255,0.07) !important;
}

/* ── 14. ADD ROW BUTTON ── */
.add-row-btn {
  font-family: 'Manrope', sans-serif !important;
  font-size: 12px !important;
  font-weight: 700 !important;
  color: #818cf8 !important;
  border-color: rgba(99,102,241,0.25) !important;
  letter-spacing: 0.02em !important;
}
.add-row-btn:hover {
  background: rgba(99,102,241,0.1) !important;
  border-color: #6366f1 !important;
  color: #a5b4fc !important;
}

/* ── 15. DOC META ROW separator ── */
.doc-meta-row {
  border-top-color: rgba(255,255,255,0.08) !important;
  padding-top: 18px !important;
  margin-top: 18px !important;
}

/* ════════════════════════════════════════════════════════════════════
   ENHANCED INPUT INTUITIVENESS — Visual Affordance System
   Makes it crystal clear where users need to input data
════════════════════════════════════════════════════════════════════ */

/* Empty input visual cue — dashed border when not filled */
.field-input:not(:focus):placeholder-shown,
.field-textarea:not(:focus):placeholder-shown {
  border-style: dashed !important;
  border-color: rgba(99,102,241,0.18) !important;
  background: linear-gradient(135deg, rgba(20,24,38,0.6) 0%, rgba(16,20,34,0.7) 100%) !important;
}

/* Field label visual indicator */
.field-label::before {
  content: '▸' !important;
  color: rgba(99,102,241,0.4) !important;
  font-size: 11px !important;
  transition: color 0.2s !important;
  margin-right: -2px !important;
}
.field-group:focus-within .field-label::before {
  color: #818cf8 !important;
}

/* Section header active indicator */
.section-head {
  position: relative !important;
}
.section-head::before {
  content: '' !important;
  position: absolute !important;
  left: 0 !important;
  top: 50% !important;
  transform: translateY(-50%) !important;
  width: 3px !important;
  height: 0 !important;
  background: linear-gradient(180deg, var(--accent), var(--teal)) !important;
  border-radius: 0 2px 2px 0 !important;
  transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
  opacity: 0 !important;
}
.section-head:hover::before {
  height: 50% !important;
  opacity: 0.5 !important;
}
.section-head.open::before {
  height: 70% !important;
  opacity: 1 !important;
}

/* Add subtle glow to focused inputs */
.field-input:focus,
.field-textarea:focus {
  box-shadow: 0 0 0 3px rgba(99,102,241,0.18),
              inset 0 1px 3px rgba(0,0,0,0.1),
              0 4px 20px rgba(99,102,241,0.15) !important;
}

/* Story row hover state for better affordance */
.story-row:hover {
  border-color: rgba(99,102,241,0.28) !important;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.08), 0 0 0 1px rgba(99,102,241,0.1) !important;
}

/* Make meta inputs more inviting */
.meta-field input:hover,
.meta-field select:hover {
  background: linear-gradient(180deg, transparent 0%, rgba(99,102,241,0.07) 100%) !important;
}

/* Enhanced button affordance */
.add-row-btn {
  position: relative !important;
  overflow: hidden !important;
}
.add-row-btn::before {
  content: '' !important;
  position: absolute !important;
  inset: 0 !important;
  background: radial-gradient(circle at center, rgba(99,102,241,0.15), transparent 70%) !important;
  opacity: 0 !important;
  transition: opacity 0.3s !important;
}
.add-row-btn:hover::before {
  opacity: 1 !important;
}

/* Form section glow on active input */
.form-section:focus-within {
  box-shadow: 0 0 0 3px rgba(99,102,241,0.12),
              0 6px 30px rgba(99,102,241,0.2),
              inset 0 1px 0 rgba(255,255,255,0.06) !important;
  background: linear-gradient(135deg, #13172090 0%, #0f131ca0 100%) !important;
}

/* Sprint table cell focus highlight */
.sprint-table td:focus-within {
  background: rgba(99,102,241,0.08) !important;
  position: relative !important;
}
.sprint-table td:focus-within::before {
  content: '' !important;
  position: absolute !important;
  left: 0 !important;
  top: 0 !important;
  bottom: 0 !important;
  width: 2px !important;
  background: var(--accent) !important;
}

/* Roadmap item hover glow */
.roadmap-item:hover {
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.1), 0 0 0 1px rgba(99,102,241,0.15) !important;
}

/* Gantt inputs enhanced hover */
.gantt-editor-row input:not(:focus):hover,
.gantt-editor-row select:not(:focus):hover {
  box-shadow: 0 0 0 1px rgba(99,102,241,0.2) !important;
}

/* Acceptance criteria numbering glow on focus */
.acceptance-row:focus-within .ac-num {
  background: rgba(99,102,241,0.25) !important;
  border-color: rgba(99,102,241,0.4) !important;
  box-shadow: 0 0 0 2px rgba(99,102,241,0.1) !important;
  color: #c4b5fd !important;
}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <!-- Burger toggle for left sidebar -->
  <button class="burger-btn" id="burgerBtn" onclick="toggleLeftSidebar()" title="Toggle sidebar">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
    </svg>
  </button>
  <!-- Visual separator -->
  <div class="nav-divider"></div>
  <div class="nav-logo">
    <div class="nav-logo-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 12h6M9 8h6M9 16h4M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <span class="nav-logo-text">PM DocStudio</span>
    <span class="nav-logo-badge">2026</span>
  </div>
  <div class="nav-center-label" id="navDocLabel">User Story</div>
  <div class="nav-actions">
    <button class="btn btn-ghost" onclick="clearDoc()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Clear
    </button>
    <button class="btn btn-primary" onclick="openExportModal()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Export
    </button>
  </div>
</nav>

<!-- WORKSPACE -->
<div class="workspace">

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar-left">
    <div class="sl-top-bar"></div>

    <!-- DOC TYPES SECTION -->
    <div class="sl-section">
      <button class="sl-collapse-btn" onclick="toggleSideSection(this)">
        <span class="sl-section-icon">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 1.5L18.5 9H13V3.5zM6 20V4h5v7h7v9H6z"/></svg>
        </span>
        <span class="sl-section-title">Documents</span>
        <svg class="sl-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="sl-section-body">
        <div class="doc-type-list">

          <div class="doc-type-item active" data-doc="user-story" onclick="switchDoc('user-story', null, this)">
            <div class="doc-type-badge badge-green">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2zm-9 11H7v-2h4v2zm6-4H7V7h10v2z"/></svg>
            </div>
            <div class="doc-type-info">
              <div class="doc-type-name">User Story</div>
              <div class="doc-type-sub">As a user, I want…</div>
            </div>
          </div>

          <div class="doc-type-item" data-doc="prd" onclick="switchDoc('prd', null, this)">
            <div class="doc-type-badge badge-slate">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zM6 20V4h6v5h5v11H6zm2-8h8v2H8v-2zm0 4h5v2H8v-2zm0-8h3v2H8V8z"/></svg>
            </div>
            <div class="doc-type-info">
              <div class="doc-type-name">PRD</div>
              <div class="doc-type-sub">Product Requirements</div>
            </div>
          </div>

          <div class="doc-type-item" data-doc="roadmap" onclick="switchDoc('roadmap', null, this)">
            <div class="doc-type-badge badge-amber">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13l4-4 4 4 4-6 4 6H3zm0 5v-2h18v2H3z"/></svg>
            </div>
            <div class="doc-type-info">
              <div class="doc-type-name">Roadmap</div>
              <div class="doc-type-sub">Quarterly planning</div>
            </div>
          </div>

          <div class="doc-type-item" data-doc="sprint" onclick="switchDoc('sprint', null, this)">
            <div class="doc-type-badge badge-rose">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.21-1.81 6-4.5 7.54L13 17v5h5l-1.22-1.22C19.91 19.07 22 15.76 22 12c0-5.18-3.95-9.45-9-9.95zM11 2.05C5.95 2.55 2 6.82 2 12c0 3.76 2.09 7.07 5.22 8.78L6 22h5v-5l-2.5 2.47C6.81 18 5 15.21 5 12c0-4.08 3.05-7.44 7-7.93V2.05z"/></svg>
            </div>
            <div class="doc-type-info">
              <div class="doc-type-name">Sprint Plan</div>
              <div class="doc-type-sub">2-week cycle</div>
            </div>
          </div>

          <div class="doc-type-item" data-doc="opp" onclick="switchDoc('opp', null, this)">
            <div class="doc-type-badge badge-violet">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>
            </div>
            <div class="doc-type-info">
              <div class="doc-type-name">Opportunity Brief</div>
              <div class="doc-type-sub">Problem → opportunity</div>
            </div>
          </div>

          <div class="doc-type-item" data-doc="gantt" onclick="switchDoc('gantt', null, this)">
            <div class="doc-type-badge badge-teal">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h2v2H3V3zm4 0h10v2H7V3zm-4 4h2v2H3V7zm4 0h7v2H7V7zm-4 4h2v2H3v-2zm4 0h10v2H7v-2zm-4 4h2v2H3v-2zm4 0h5v2H7v-2z"/></svg>
            </div>
            <div class="doc-type-info">
              <div class="doc-type-name">Gantt Chart</div>
              <div class="doc-type-sub">Timeline & milestones</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- PROGRESS SECTION -->
    <div class="sl-section">
      <button class="sl-collapse-btn" onclick="toggleSideSection(this)">
        <span class="sl-section-icon">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
        </span>
        <span class="sl-section-title">Completion</span>
        <span class="sl-pct-badge" id="progressPct">0%</span>
        <svg class="sl-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="sl-section-body">
        <div class="progress-wrap">
          <div class="progress-label">
            <span id="progressLabel">0 of 0 fields</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- PM TIP SECTION -->
    <div class="sl-section">
      <button class="sl-collapse-btn" onclick="toggleSideSection(this)">
        <span class="sl-section-icon">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>
        </span>
        <span class="sl-section-title">PM Tip</span>
        <svg class="sl-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="sl-section-body">
        <div class="tip-card" id="tipCard">
          <strong>User Stories</strong> should be small enough to complete in one sprint. If it's too large, split it into multiple stories with the same goal.
        </div>
      </div>
    </div>

  </aside>

  <!-- EDITOR -->
  <main class="editor-area" id="editorArea">
    <!-- dynamically rendered -->
  </main>

  <!-- RIGHT PREVIEW -->
  <aside class="sidebar-right" id="sidebarRight">

    <!-- PREVIEW HEADER — bold, vivid, prominent -->
    <div class="preview-header">
      <div class="preview-header-card">
        <!-- Icon -->
        <div class="preview-header-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 1.5L18.5 9H13V3.5zM6 20V4h5v7h7v9H6zm2-8h8v1.5H8V12zm0 3h8v1.5H8V15zm0 3h5v1.5H8V18z"/></svg>
        </div>
        <!-- Text block -->
        <div class="preview-header-info">
          <div class="preview-header-label">Live Preview</div>
          <div class="preview-header-sub">
            <span class="live-pill">
              <span class="live-dot"></span>
              Live
            </span>
            <span class="auto-tag">auto-sync</span>
          </div>
        </div>
      </div>
      <div class="preview-header-divider"></div>
    </div>

    <!-- PREVIEW BODY -->
    <div class="preview-body">
      <div class="preview-doc" id="previewDoc">
        <div class="preview-empty">
          <div class="preview-empty-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke="rgba(99,102,241,0.6)" stroke-width="1.5" stroke-linejoin="round"/><path d="M14 2v6h6M8 13h8M8 17h5" stroke="rgba(99,102,241,0.6)" stroke-width="1.5" stroke-linecap="round"/></svg>
          </div>
          <div class="preview-empty-text">Fill in the form to see your document appear here in real time</div>
          <div class="preview-empty-hint">← start typing on the left</div>
        </div>
      </div>
    </div>

    <!-- EXPORT FOOTER -->
    <div class="export-footer">
      <button class="cta-export-btn" onclick="openExportModal()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Export Document
      </button>
      <button class="cta-copy-btn" onclick="copyDocument()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Copy to Clipboard
      </button>
    </div>

  </aside>

  <!-- EXPORT MODAL (injected by JS) -->

</div>

<!-- RIGHT PANEL TOGGLE TAB — fixed, always visible -->
<button class="right-toggle-tab panel-open" id="rightToggleTab" onclick="toggleRightSidebar()" title="Toggle preview panel">
  <svg id="rightToggleIcon" width="13" height="13" viewBox="0 0 24 24" fill="none">
    <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<div class="toast" id="toast"></div>

<script>
// ─── STATE ───────────────────────────────────────────────────
let currentDoc = 'user-story';
let storyRows = [{ who: '', want: '', so: '' }];
let acceptanceRows = [''];
let roadmapItems = [
  { quarter: 'Q1', theme: '', items: '', status: 'planned' },
  { quarter: 'Q2', theme: '', items: '', status: 'planned' },
  { quarter: 'Q3', theme: '', items: '', status: 'planned' },
  { quarter: 'Q4', theme: '', items: '', status: 'planned' },
];
let sprintRows = [{ task: '', owner: '', points: '', status: 'todo' }];

const tips = {
  'user-story': '📝 <strong>User Stories</strong> should be small enough to complete in one sprint. If it\'s too large, split it into multiple stories with the same goal.',
  'prd': '📋 <strong>PRDs</strong> should answer WHY before WHAT. A strong problem statement prevents scope creep better than any process.',
  'roadmap': '🗺️ A good <strong>Roadmap</strong> communicates intent, not a promise. Always pair each item with the user problem it solves.',
  'sprint': '⚡ <strong>Sprint Goals</strong> should be outcome-based ("reduce drop-off"), not output-based ("ship X feature"). Goals create focus.',
  'opp': '💡 An <strong>Opportunity Brief</strong> should be shareable in a Slack message. If it takes 10 mins to explain, the thinking isn\'t clear enough yet.',
  'gantt': '📊 <strong>Gantt Charts</strong> communicate sequence and dependencies, not just dates. Always show who owns each bar — ownership without deadlines is just a wish list.',
};

// ─── GANTT STATE ─────────────────────────────────────────────
let ganttTasks = [
  { id:1, name:'Discovery & Research',  owner:'PM',       start:1,  dur:2, status:'done',       color:'#1e7a5a', pct:100 },
  { id:2, name:'Design & Wireframes',   owner:'Designer', start:3,  dur:3, status:'inprogress', color:'#2d4a7a', pct:60  },
  { id:3, name:'Frontend Development',  owner:'Dev Team', start:5,  dur:4, status:'notstarted', color:'#0d7a72', pct:0   },
  { id:4, name:'Backend / API',         owner:'Backend',  start:5,  dur:3, status:'notstarted', color:'#5a3a8a', pct:0   },
  { id:5, name:'QA & Testing',          owner:'QA',       start:9,  dur:2, status:'notstarted', color:'#b8621a', pct:0   },
  { id:6, name:'Launch & Monitoring',   owner:'PM',       start:11, dur:2, status:'notstarted', color:'#a8334c', pct:0   },
];
let ganttWeeks = 12;
let ganttTodayWeek = 3;
const COLORS = ['#1e7a5a','#2d4a7a','#0d7a72','#5a3a8a','#b8621a','#a8334c','#c49a3c','#3a5ae0'];

function renderGantt() {
  return `
<div class="doc-header" style="margin-bottom:24px">
  <div class="doc-type-tag" style="background:#e6f4f3;color:#0d7a72;"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h2v2H3V3zm4 0h10v2H7V3zm-4 4h2v2H3V7zm4 0h7v2H7V7zm-4 4h2v2H3v-2zm4 0h10v2H7v-2zm-4 4h2v2H3v-2zm4 0h5v2H7v-2z"/></svg> GANTT CHART</div>
  <textarea class="doc-title-input" id="docTitle" placeholder="Project or feature name..." rows="1"
    oninput="autoResize(this);renderGanttChart()" onkeyup="renderGanttChart()"></textarea>
  <div class="doc-meta-row">
    <div class="meta-field"><label>Start Date</label><input id="ganttStartDate" type="date" oninput="renderGanttChart()"></div>
    <div class="meta-field"><label>Weeks</label>
      <select id="ganttWeeks" oninput="ganttWeeks=parseInt(this.value);renderGanttChart()">
        ${[4,6,8,10,12,16,20,24].map(w=>`<option value="${w}" ${w===12?'selected':''}>${w} weeks</option>`).join('')}
      </select>
    </div>
    <div class="meta-field"><label>Today = Week</label>
      <input id="ganttToday" type="number" min="1" value="${ganttTodayWeek}" style="max-width:70px"
        oninput="ganttTodayWeek=parseInt(this.value)||1;renderGanttChart()">
    </div>
    <div class="meta-field"><label>Team / Author</label><input id="ganttAuthor" placeholder="Your name" oninput="renderGanttChart()"></div>
  </div>
</div>

<div class="gantt-workspace form-section" style="margin-bottom:28px">
  <div style="padding:18px 22px;border-bottom:1px solid var(--border)">
    <div class="gantt-section-label">Tasks</div>
    <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 80px auto;gap:6px;margin-bottom:8px;padding:0 2px">
      ${['Task Name','Owner','Start Wk','Duration','Status','% Done',''].map(h=>`<div style="font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted)">${h}</div>`).join('')}
    </div>
    <div id="ganttEditorRows"></div>
    <button class="add-row-btn" onclick="addGanttTask()" style="margin-top:6px">+ Add Task</button>
  </div>
  <div class="gantt-canvas-wrap">
    <div id="ganttChartInner"></div>
  </div>
  <div class="gantt-legend">
    <div class="gantt-legend-item"><span class="gstatus gstatus-notstarted">not started</span></div>
    <div class="gantt-legend-item"><span class="gstatus gstatus-inprogress">in progress</span></div>
    <div class="gantt-legend-item"><span class="gstatus gstatus-done">done</span></div>
    <div class="gantt-legend-item"><span class="gstatus gstatus-atrisk">at risk</span></div>
    <div class="gantt-legend-item"><span class="gstatus gstatus-blocked">blocked</span></div>
    <div class="gantt-legend-item" style="margin-left:auto">
      <span style="display:inline-block;width:10px;height:10px;background:var(--rose);border-radius:50%;opacity:0.5;margin-right:5px"></span>Today marker
    </div>
  </div>
</div>

<div class="gantt-export-bar">
  <span class="gantt-export-label">Export</span>
  <button class="gantt-xbtn x-pdf"  onclick="exportPDF()"    title="Save as PDF"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg> PDF</button>
  <button class="gantt-xbtn x-csv"  onclick="exportCSV()"    title="Download as Excel/CSV"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 8H19v6h-2.8v-6z"/></svg> Excel / CSV</button>
  <button class="gantt-xbtn x-json" onclick="exportJSON()"   title="Download structured JSON"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3c-1.1 0-2 .9-2 2v2h2V5h2V3H5zm6 0v2h2V3h-2zm4 0v2h2c0 1.1.9 2 2 2v2h2V7c0-2.21-1.79-4-4-4h-4zM3 11v2h2v-2H3zm16 0v2h2v-2h-2zM3 15v4c0 1.1.9 2 2 2h2v-2H5v-2h2v-2H5v-2H3zm18 0v2h-2v2h2c1.1 0 2-.9 2-2v-4h-2v2zm-8 4v2h-2v-2h2zm-4 0v2H7v-2h2z"/></svg> JSON</button>
  <button class="gantt-xbtn x-primary" onclick="openExportModal()" title="All export options"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg> All Options</button>
  <button class="gantt-xbtn x-copy" onclick="copyDocument()" title="Copy to clipboard"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy</button>
</div>
`;
}

function renderGanttEditorRows() {
  const container = document.getElementById('ganttEditorRows');
  if (!container) return;
  container.innerHTML = ganttTasks.map((t, i) => `
    <div class="gantt-editor-row">
      <input value="${t.name}" placeholder="Task name..." oninput="ganttTasks[${i}].name=this.value;renderGanttChart()">
      <input value="${t.owner}" placeholder="Owner" oninput="ganttTasks[${i}].owner=this.value;renderGanttChart()">
      <input type="number" min="1" max="${ganttWeeks}" value="${t.start}" oninput="ganttTasks[${i}].start=Math.max(1,parseInt(this.value)||1);renderGanttChart()">
      <input type="number" min="1" max="${ganttWeeks}" value="${t.dur}" oninput="ganttTasks[${i}].dur=Math.max(1,parseInt(this.value)||1);renderGanttChart()">
      <select oninput="ganttTasks[${i}].status=this.value;renderGanttChart()">
        ${['notstarted','inprogress','done','atrisk','blocked'].map(s=>`<option value="${s}" ${t.status===s?'selected':''}>${s}</option>`).join('')}
      </select>
      <input type="number" min="0" max="100" value="${t.pct}" oninput="ganttTasks[${i}].pct=Math.min(100,Math.max(0,parseInt(this.value)||0));renderGanttChart()">
      <div style="display:flex;align-items:center;gap:6px">
        <div style="width:14px;height:14px;border-radius:50%;background:${t.color};flex-shrink:0;cursor:pointer;border:2px solid rgba(0,0,0,0.1)"
          title="Click to change color" onclick="cycleColor(${i})"></div>
        ${ganttTasks.length > 1 ? `<button class="remove-row-btn" onclick="removeGanttTask(${i})">×</button>` : ''}
      </div>
    </div>
  `).join('');
}

function renderGanttChart() {
  const inner = document.getElementById('ganttChartInner');
  if (!inner) return;
  const weeks = ganttWeeks;
  const today = ganttTodayWeek;

  let headerCells = `<th class="gantt-cell-task">Task</th><th class="gantt-cell-meta" style="min-width:80px">Owner</th><th class="gantt-cell-meta" style="min-width:72px">Status</th><th class="gantt-cell-meta" style="min-width:56px">Done</th>`;
  for (let w = 1; w <= weeks; w++) {
    const isToday = w === today;
    headerCells += `<th class="gantt-week-header${isToday?' gantt-today-line':''}" title="Week ${w}">W${w}</th>`;
  }

  const statusLabels = { notstarted:'Not Started', inprogress:'In Progress', done:'Done', atrisk:'At Risk', blocked:'Blocked' };

  let rows = ganttTasks.map(t => {
    const statusClass = `gstatus gstatus-${t.status}`;
    const label = statusLabels[t.status] || t.status;
    let weekCells = '';
    for (let w = 1; w <= weeks; w++) {
      const inTask = (w >= t.start && w < t.start + t.dur);
      const isStart = w === t.start;
      const isEnd = w === t.start + t.dur - 1;
      const isToday = w === today;
      const tdClass = `gantt-cell-week${isToday?' gantt-today-line':''}`;
      const tdStyle = isToday ? 'background:rgba(168,51,76,0.03)' : '';
      if (inTask) {
        const br = isStart && isEnd ? '4px' : (isStart ? '4px 0 0 4px' : (isEnd ? '0 4px 4px 0' : '0'));
        weekCells += `<td class="${tdClass}" style="${tdStyle}">
          <div style="position:relative;height:18px;border-radius:${br};background:${t.color}22">
            <div style="position:absolute;top:0;left:0;bottom:0;width:${t.pct}%;background:${t.color};border-radius:${br};opacity:0.75;transition:width 0.3s"></div>
          </div></td>`;
      } else {
        weekCells += `<td class="${tdClass}" style="${tdStyle}"></td>`;
      }
    }
    return `<tr class="gantt-row">
      <td class="gantt-cell-task">
        <div style="display:flex;align-items:center;gap:8px">
          <div style="width:3px;height:34px;border-radius:2px;background:${t.color};flex-shrink:0"></div>
          <div><div class="gantt-task-name">${t.name||'Unnamed Task'}</div><div class="gantt-task-owner">${t.owner||''}</div></div>
        </div>
      </td>
      <td class="gantt-cell-meta" style="font-size:12px;color:var(--muted)">${t.owner||'—'}</td>
      <td class="gantt-cell-meta"><span class="${statusClass}">${label}</span></td>
      <td class="gantt-cell-meta">
        <div style="display:flex;align-items:center;gap:5px">
          <div style="width:36px;height:5px;background:var(--border);border-radius:3px;overflow:hidden">
            <div style="height:100%;width:${t.pct}%;background:${t.color};border-radius:3px;transition:width 0.3s"></div>
          </div>
          <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted)">${t.pct}%</span>
        </div>
      </td>${weekCells}
    </tr>`;
  }).join('');

  inner.innerHTML = `<table class="gantt-table"><thead><tr>${headerCells}</tr></thead><tbody>${rows}</tbody></table>`;
  renderGanttEditorRows();
}

function addGanttTask() {
  const last = ganttTasks[ganttTasks.length - 1];
  ganttTasks.push({ id: Date.now(), name: '', owner: '', start: last ? Math.min(last.start + last.dur, ganttWeeks) : 1, dur: 2, status: 'notstarted', color: COLORS[ganttTasks.length % COLORS.length], pct: 0 });
  renderGanttChart();
}

function removeGanttTask(i) {
  ganttTasks.splice(i, 1);
  renderGanttChart();
}

function cycleColor(i) {
  const cur = COLORS.indexOf(ganttTasks[i].color);
  ganttTasks[i].color = COLORS[(cur + 1) % COLORS.length];
  renderGanttChart();
}

// ─── DOC TEMPLATES ───────────────────────────────────────────
function renderUserStory() {
  return `
<div class="doc-header">
  <div class="doc-type-tag" style="background:var(--green-bg);color:var(--green);">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2zm-9 11H7v-2h4v2zm6-4H7V7h10v2z"/></svg> USER STORY
  </div>
  <textarea class="doc-title-input" id="docTitle" placeholder="Feature or story name..." rows="1" oninput="autoResize(this);updatePreview()" onkeyup="updatePreview()"></textarea>
  <div class="doc-meta-row">
    <div class="meta-field"><label>Author</label><input id="metaAuthor" placeholder="Your name" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Epic</label><input id="metaEpic" placeholder="Parent epic" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Sprint</label><input id="metaSprint" placeholder="Sprint 12" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Priority</label>
      <div class="priority-pills" id="priorityPills">
        <div class="priority-pill" onclick="setPriority('P0',this)"><svg width="9" height="9" viewBox="0 0 10 10" fill="currentColor"><circle cx="5" cy="5" r="5"/></svg> P0</div>
        <div class="priority-pill" onclick="setPriority('P1',this)"><svg width="9" height="9" viewBox="0 0 10 10" fill="currentColor"><circle cx="5" cy="5" r="5"/></svg> P1</div>
        <div class="priority-pill sel-p3" onclick="setPriority('P2',this)"><svg width="9" height="9" viewBox="0 0 10 10" fill="currentColor"><circle cx="5" cy="5" r="5"/></svg> P2</div>
        <div class="priority-pill" onclick="setPriority('P3',this)"><svg width="9" height="9" viewBox="0 0 10 10" fill="currentColor"><circle cx="5" cy="5" r="5" opacity="0.4"/></svg> P3</div>
      </div>
    </div>
  </div>
</div>
<div class="form-sections">

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-green"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2zm-9 11H7v-2h4v2zm6-4H7V7h10v2z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">User Stories</div>
        <div class="section-head-desc">As a [who], I want [what], so that [why]</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body" id="sb-stories">
      <div class="story-rows" id="storyRows"></div>
      <button class="add-row-btn" onclick="addStoryRow()">+ Add Story</button>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-green"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Acceptance Criteria</div>
        <div class="section-head-desc">Given/When/Then — definition of done</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body" id="sb-acceptance">
      <div id="acceptanceRows"></div>
      <button class="add-row-btn" onclick="addAcceptanceRow()">+ Add Criterion</button>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-green"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm0-12.5c-2.49 0-4.5 2.01-4.5 4.5s2.01 4.5 4.5 4.5 4.5-2.01 4.5-4.5-2.01-4.5-4.5-4.5zm0 5.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Background & Context</div>
        <div class="section-head-desc">Why does this story exist? What's the problem?</div>
      </div>
      <span class="section-optional">Optional</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body" id="sb-context">
      <div class="field-group">
        <div class="field-label">Problem Statement <span class="req">*</span></div>
        <textarea class="field-textarea" id="problemStatement" placeholder="What user problem or business need does this story address?" oninput="updatePreview()"></textarea>
      </div>
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">Success Metric</div>
          <input class="field-input" id="successMetric" placeholder="e.g., +15% task completion rate" oninput="updatePreview()">
        </div>
        <div class="field-group">
          <div class="field-label">Story Points</div>
          <input class="field-input" id="storyPoints" placeholder="e.g., 5" type="number" oninput="updatePreview()">
        </div>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-green"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9A7.902 7.902 0 014 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1A7.902 7.902 0 0120 12c0 4.42-3.58 8-8 8z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Out of Scope</div>
        <div class="section-head-desc">Explicitly what this story does NOT include</div>
      </div>
      <span class="section-optional">Optional</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body" id="sb-oos">
      <div class="field-group">
        <textarea class="field-textarea" id="outOfScope" placeholder="List things explicitly excluded from this story to prevent scope creep..." oninput="updatePreview()"></textarea>
        <div class="field-hint">Being explicit about exclusions prevents misaligned expectations with engineering.</div>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-green"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7h-4v2h4c1.65 0 3 1.35 3 3s-1.35 3-3 3h-4v2h4c2.76 0 5-2.24 5-5s-2.24-5-5-5zm-6 8H7c-1.65 0-3-1.35-3-3s1.35-3 3-3h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-2zm-3-4h8v2H8v-2z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Dependencies & Notes</div>
        <div class="section-head-desc">Blockers, related tickets, design links</div>
      </div>
      <span class="section-optional">Optional</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body" id="sb-deps">
      <div class="field-group">
        <div class="field-label">Dependencies</div>
        <textarea class="field-textarea" id="dependencies" placeholder="e.g., Blocked by Auth API (JIRA-234), needs design approval from @Priya..." oninput="updatePreview()" style="min-height:70px"></textarea>
      </div>
      <div class="field-group">
        <div class="field-label">Additional Notes</div>
        <textarea class="field-textarea" id="notes" placeholder="Edge cases, technical considerations, stakeholder comments..." oninput="updatePreview()" style="min-height:70px"></textarea>
      </div>
    </div>
  </div>

</div>`;
}

function renderPRD() {
  return `
<div class="doc-header">
  <div class="doc-type-tag" style="background:var(--slate-bg);color:var(--slate);"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zM6 20V4h6v5h5v11H6zm2-8h8v2H8v-2zm0 4h5v2H8v-2zm0-8h3v2H8V8z"/></svg> PRODUCT REQUIREMENTS DOCUMENT</div>
  <textarea class="doc-title-input" id="docTitle" placeholder="Product or feature name..." rows="1" oninput="autoResize(this);updatePreview()" onkeyup="updatePreview()"></textarea>
  <div class="doc-meta-row">
    <div class="meta-field"><label>Author</label><input id="metaAuthor" placeholder="PM name" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Version</label><input id="metaVersion" placeholder="v1.0" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Date</label><input id="metaDate" type="date" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Status</label>
      <select id="metaStatus" oninput="updatePreview()">
        <option>Draft</option><option>In Review</option><option>Approved</option><option>Shipped</option>
      </select>
    </div>
  </div>
</div>
<div class="form-sections">

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-slate"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm0-12.5c-2.49 0-4.5 2.01-4.5 4.5s2.01 4.5 4.5 4.5 4.5-2.01 4.5-4.5-2.01-4.5-4.5-4.5zm0 5.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Problem Statement</div>
        <div class="section-head-desc">The pain we're solving and for whom</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="field-group">
        <div class="field-label">Problem <span class="req">*</span></div>
        <textarea class="field-textarea" id="prdProblem" placeholder="Describe the specific problem users or the business is facing..." oninput="updatePreview()"></textarea>
      </div>
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">Target User</div>
          <input class="field-input" id="prdUser" placeholder="e.g., First-time mobile shoppers" oninput="updatePreview()">
        </div>
        <div class="field-group">
          <div class="field-label">User Impact</div>
          <input class="field-input" id="prdImpact" placeholder="e.g., ~200K users affected monthly" oninput="updatePreview()">
        </div>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-slate"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94A5.01 5.01 0 0011 15.9V18H9v2h6v-2h-2v-2.1a5.01 5.01 0 003.61-2.96C19.08 12.63 21 10.55 21 8V7c0-1.1-.9-2-2-2zM5 8V7h2v3.82C5.86 10.4 5 9.3 5 8zm14 0c0 1.3-.86 2.4-2 2.82V7h2v1z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Goals & Success Metrics</div>
        <div class="section-head-desc">What does winning look like?</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="field-group">
        <div class="field-label">Primary Goal</div>
        <input class="field-input" id="prdGoal" placeholder="e.g., Reduce checkout drop-off by 20% in Q2" oninput="updatePreview()">
      </div>
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">North Star Metric</div>
          <input class="field-input" id="prdNSM" placeholder="e.g., Checkout completion rate" oninput="updatePreview()">
        </div>
        <div class="field-group">
          <div class="field-label">Guardrail Metric</div>
          <input class="field-input" id="prdGuardrail" placeholder="e.g., Must not reduce AOV" oninput="updatePreview()">
        </div>
      </div>
      <div class="field-group">
        <div class="field-label">Supporting Metrics</div>
        <textarea class="field-textarea" id="prdMetrics" placeholder="Secondary metrics you'll track (session time, error rate, NPS, etc.)" oninput="updatePreview()" style="min-height:70px"></textarea>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-slate"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Requirements</div>
        <div class="section-head-desc">Functional and non-functional requirements</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="field-group">
        <div class="field-label">Functional Requirements</div>
        <textarea class="field-textarea" id="prdFunctional" placeholder="What the product must DO:&#10;- Users can save payment methods&#10;- System supports Apple Pay and Google Pay&#10;- Checkout completes in < 3 taps" oninput="updatePreview()"></textarea>
      </div>
      <div class="field-group">
        <div class="field-label">Non-Functional Requirements</div>
        <textarea class="field-textarea" id="prdNonFunctional" placeholder="Performance, security, scalability requirements:&#10;- Page load < 2s&#10;- PCI-DSS compliant&#10;- 99.9% uptime" oninput="updatePreview()"></textarea>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-slate"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9A7.902 7.902 0 014 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1A7.902 7.902 0 0120 12c0 4.42-3.58 8-8 8z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Out of Scope & Assumptions</div>
        <div class="section-head-desc">Boundaries and assumptions baked into this PRD</div>
      </div>
      <span class="section-optional">Optional</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">Out of Scope</div>
          <textarea class="field-textarea" id="prdOOS" placeholder="What this PRD explicitly excludes..." oninput="updatePreview()" style="min-height:100px"></textarea>
        </div>
        <div class="field-group">
          <div class="field-label">Assumptions</div>
          <textarea class="field-textarea" id="prdAssumptions" placeholder="What we're assuming to be true (to be validated)..." oninput="updatePreview()" style="min-height:100px"></textarea>
        </div>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-slate"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 002 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7v-5z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Timeline & Risks</div>
        <div class="section-head-desc">Key milestones and known blockers</div>
      </div>
      <span class="section-optional">Optional</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">Target Launch</div>
          <input class="field-input" id="prdLaunch" placeholder="e.g., End of Q2 2025" oninput="updatePreview()">
        </div>
        <div class="field-group">
          <div class="field-label">Engineering Owner</div>
          <input class="field-input" id="prdEng" placeholder="e.g., Rohan / Checkout team" oninput="updatePreview()">
        </div>
      </div>
      <div class="field-group">
        <div class="field-label">Risks & Mitigations</div>
        <textarea class="field-textarea" id="prdRisks" placeholder="Known risks and how you plan to mitigate them..." oninput="updatePreview()"></textarea>
      </div>
    </div>
  </div>

</div>`;
}

function renderRoadmap() {
  return `
<div class="doc-header">
  <div class="doc-type-tag" style="background:var(--amber-bg);color:var(--amber);"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13l4-4 4 4 4-6 4 6H3zm0 5v-2h18v2H3z"/></svg> PRODUCT ROADMAP</div>
  <textarea class="doc-title-input" id="docTitle" placeholder="Product area or team roadmap..." rows="1" oninput="autoResize(this);updatePreview()" onkeyup="updatePreview()"></textarea>
  <div class="doc-meta-row">
    <div class="meta-field"><label>Team</label><input id="metaTeam" placeholder="Growth / Platform / Core" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Year</label><input id="metaYear" placeholder="2025" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Author</label><input id="metaAuthor" placeholder="PM name" oninput="updatePreview()"></div>
  </div>
</div>
<div class="form-sections">

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-amber"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Vision & Strategy</div>
        <div class="section-head-desc">Where we're going and why</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="field-group">
        <div class="field-label">Vision Statement</div>
        <textarea class="field-textarea" id="rdmVision" placeholder="What does the world look like if we succeed? (1-2 inspiring sentences)" oninput="updatePreview()" style="min-height:70px"></textarea>
      </div>
      <div class="field-group">
        <div class="field-label">Strategic Bets</div>
        <textarea class="field-textarea" id="rdmBets" placeholder="3 key strategic bets for this year:&#10;1. Bet on mobile-first engagement&#10;2. Expand to B2B segment&#10;3. Reduce onboarding friction" oninput="updatePreview()"></textarea>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-amber"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 002 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7v-5z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Quarterly Themes</div>
        <div class="section-head-desc">What each quarter is focused on</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div style="display:flex;flex-direction:column;gap:14px;">
        ${['Q1','Q2','Q3','Q4'].map((q,i) => `
        <div class="roadmap-item">
          <div class="roadmap-item-fields">
            <div class="roadmap-quarter-label">${q} · 2025</div>
            <input class="roadmap-item-input" id="rdm${q}Theme" placeholder="Quarter theme (e.g., Foundation & Stability)" oninput="updatePreview()">
            <input class="roadmap-item-input" style="font-size:12px;color:var(--muted);margin-top:4px;" id="rdm${q}Items" placeholder="Key initiatives: Login redesign, API v2, Onboarding flow..." oninput="updatePreview()">
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
            <select style="font-family:'JetBrains Mono',monospace;font-size:10px;border:1px solid var(--border2);border-radius:6px;padding:4px 8px;background:var(--surface2);color:var(--ink2);cursor:pointer;outline:none;" id="rdm${q}Status" oninput="updatePreview()">
              <option>Planned</option><option>In Progress</option><option>Complete</option><option>At Risk</option>
            </select>
          </div>
        </div>`).join('')}
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-amber"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 8H19v6h-2.8v-6z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">OKRs</div>
        <div class="section-head-desc">Objectives and Key Results for the period</div>
      </div>
      <span class="section-optional">Optional</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="field-group">
        <div class="field-label">Objective</div>
        <input class="field-input" id="rdmObj" placeholder="e.g., Become the most trusted checkout experience in D2C" oninput="updatePreview()">
      </div>
      <div class="field-group">
        <div class="field-label">Key Results</div>
        <textarea class="field-textarea" id="rdmKRs" placeholder="KR1: Increase checkout conversion from 61% to 78%&#10;KR2: Reduce average checkout time from 4.2 to 2.5 mins&#10;KR3: Achieve NPS of 45+ for checkout experience" oninput="updatePreview()"></textarea>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-amber"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Dependencies & Risks</div>
        <div class="section-head-desc">What could derail the plan</div>
      </div>
      <span class="section-optional">Optional</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">Cross-team Dependencies</div>
          <textarea class="field-textarea" id="rdmDeps" placeholder="Teams or external systems this roadmap depends on..." oninput="updatePreview()" style="min-height:90px"></textarea>
        </div>
        <div class="field-group">
          <div class="field-label">Key Risks</div>
          <textarea class="field-textarea" id="rdmRisks" placeholder="Things that could delay or derail this roadmap..." oninput="updatePreview()" style="min-height:90px"></textarea>
        </div>
      </div>
    </div>
  </div>

</div>`;
}

function renderSprint() {
  return `
<div class="doc-header">
  <div class="doc-type-tag" style="background:var(--rose-bg);color:var(--rose);"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.21-1.81 6-4.5 7.54L13 17v5h5l-1.22-1.22C19.91 19.07 22 15.76 22 12c0-5.18-3.95-9.45-9-9.95zM11 2.05C5.95 2.55 2 6.82 2 12c0 3.76 2.09 7.07 5.22 8.78L6 22h5v-5l-2.5 2.47C6.81 18 5 15.21 5 12c0-4.08 3.05-7.44 7-7.93V2.05z"/></svg> SPRINT PLAN</div>
  <textarea class="doc-title-input" id="docTitle" placeholder="Sprint name or number..." rows="1" oninput="autoResize(this);updatePreview()" onkeyup="updatePreview()"></textarea>
  <div class="doc-meta-row">
    <div class="meta-field"><label>Sprint #</label><input id="metaSprint" placeholder="Sprint 14" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Start Date</label><input id="metaStart" type="date" oninput="updatePreview()"></div>
    <div class="meta-field"><label>End Date</label><input id="metaEnd" type="date" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Team</label><input id="metaTeam" placeholder="Team name" oninput="updatePreview()"></div>
  </div>
</div>
<div class="form-sections">

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-rose"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Sprint Goal</div>
        <div class="section-head-desc">One sentence — what does this sprint achieve?</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="field-group">
        <div class="field-label">Goal Statement <span class="req">*</span></div>
        <textarea class="field-textarea" id="sprintGoal" placeholder="e.g., Enable users to complete onboarding without support intervention, reducing onboarding drop-off by 30%." oninput="updatePreview()" style="min-height:70px"></textarea>
        <div class="field-hint">Make it outcome-based, not task-based. Bad: "Ship the new onboarding." Good: "Users can self-serve through onboarding."</div>
      </div>
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">Sprint Capacity (points)</div>
          <input class="field-input" id="sprintCapacity" placeholder="e.g., 40" type="number" oninput="updatePreview()">
        </div>
        <div class="field-group">
          <div class="field-label">Success Signal</div>
          <input class="field-input" id="sprintSuccess" placeholder="e.g., Onboarding rate > 75%" oninput="updatePreview()">
        </div>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-rose"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Sprint Backlog</div>
        <div class="section-head-desc">Tasks committed to this sprint</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body" id="sb-sprint-backlog">
      <table class="sprint-table" id="sprintTable">
        <thead>
          <tr>
            <th>Task / Story</th>
            <th>Owner</th>
            <th>Points</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="sprintRows"></tbody>
      </table>
      <button class="add-row-btn" style="margin-top:10px" onclick="addSprintRow()">+ Add Task</button>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-rose"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9A7.902 7.902 0 014 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1A7.902 7.902 0 0120 12c0 4.42-3.58 8-8 8z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Carry-over & Blockers</div>
        <div class="section-head-desc">From last sprint and current blockers</div>
      </div>
      <span class="section-optional">Optional</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">Carried Over from Last Sprint</div>
          <textarea class="field-textarea" id="carryover" placeholder="Tasks or stories not completed last sprint..." oninput="updatePreview()" style="min-height:80px"></textarea>
        </div>
        <div class="field-group">
          <div class="field-label">Current Blockers</div>
          <textarea class="field-textarea" id="blockers" placeholder="Known blockers that need resolution..." oninput="updatePreview()" style="min-height:80px"></textarea>
        </div>
      </div>
    </div>
  </div>

</div>`;
}

function renderOpp() {
  return `
<div class="doc-header">
  <div class="doc-type-tag" style="background:var(--violet-bg);color:var(--violet);"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg> OPPORTUNITY BRIEF</div>
  <textarea class="doc-title-input" id="docTitle" placeholder="Opportunity name..." rows="1" oninput="autoResize(this);updatePreview()" onkeyup="updatePreview()"></textarea>
  <div class="doc-meta-row">
    <div class="meta-field"><label>Author</label><input id="metaAuthor" placeholder="PM name" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Date</label><input id="metaDate" type="date" oninput="updatePreview()"></div>
    <div class="meta-field"><label>Confidence</label>
      <select id="metaConfidence" oninput="updatePreview()">
        <option>Low — Hunch</option><option>Medium — Some data</option><option>High — Validated</option>
      </select>
    </div>
  </div>
</div>
<div class="form-sections">

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-violet"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">The Problem</div>
        <div class="section-head-desc">Whose problem, what problem, and why now?</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="field-group">
        <div class="field-label">Who has this problem?</div>
        <input class="field-input" id="oppWho" placeholder="e.g., SMB customers with 5-50 employees trying to manage invoicing" oninput="updatePreview()">
      </div>
      <div class="field-group">
        <div class="field-label">What is the problem?</div>
        <textarea class="field-textarea" id="oppWhat" placeholder="Describe the specific friction, pain, or unmet need in concrete terms." oninput="updatePreview()"></textarea>
      </div>
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">How big is this problem?</div>
          <input class="field-input" id="oppSize" placeholder="e.g., Affects 40% of DAU, 12K users" oninput="updatePreview()">
        </div>
        <div class="field-group">
          <div class="field-label">Evidence / Signal</div>
          <input class="field-input" id="oppEvidence" placeholder="e.g., 34 support tickets, NPS feedback, data spike" oninput="updatePreview()">
        </div>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-violet"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">The Opportunity</div>
        <div class="section-head-desc">What becomes possible if we solve this?</div>
      </div>
      <span class="section-required">Required</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="field-group">
        <div class="field-label">Opportunity Statement</div>
        <textarea class="field-textarea" id="oppStatement" placeholder="If we solve [problem] for [users], we can unlock [business outcome]." oninput="updatePreview()"></textarea>
      </div>
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">Business Impact (est.)</div>
          <input class="field-input" id="oppBizImpact" placeholder="e.g., +8% retention, +₹2Cr ARR" oninput="updatePreview()">
        </div>
        <div class="field-group">
          <div class="field-label">Strategic Fit</div>
          <input class="field-input" id="oppStrategic" placeholder="e.g., Aligns with Q2 retention OKR" oninput="updatePreview()">
        </div>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-violet"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19.8 18.4L14 10.67V6h1c.55 0 1-.45 1-1s-.45-1-1-1H9c-.55 0-1 .45-1 1s.45 1 1 1h1v4.67l-5.8 7.73C3.71 19.97 4.37 22 6 22h12c1.63 0 2.29-2.03 1.8-3.6z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Solution Space</div>
        <div class="section-head-desc">Possible approaches (not commitments)</div>
      </div>
      <span class="section-optional">Optional</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="field-group">
        <div class="field-label">Possible Approaches</div>
        <textarea class="field-textarea" id="oppSolutions" placeholder="Option A: ...&#10;Option B: ...&#10;Option C: ..." oninput="updatePreview()"></textarea>
        <div class="field-hint">Don't commit to a solution here — this brief is about defining the opportunity. Solutions come after validation.</div>
      </div>
      <div class="field-group">
        <div class="field-label">What we'd need to validate</div>
        <textarea class="field-textarea" id="oppValidation" placeholder="e.g., User interviews with 5 SMB customers, A/B test on invoice flow, prototype test" oninput="updatePreview()" style="min-height:70px"></textarea>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="section-head open" onclick="toggleSection(this)">
      <div class="section-head-icon badge-violet"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg></div>
      <div class="section-head-text">
        <div class="section-head-title">Why Now? Why Us?</div>
        <div class="section-head-desc">Urgency and right-to-win</div>
      </div>
      <span class="section-optional">Optional</span>
      <div class="section-toggle"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    </div>
    <div class="section-body">
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">Why is the timing right?</div>
          <textarea class="field-textarea" id="oppWhyNow" placeholder="Market shift, user behavior change, competitor move..." oninput="updatePreview()" style="min-height:90px"></textarea>
        </div>
        <div class="field-group">
          <div class="field-label">Our competitive advantage</div>
          <textarea class="field-textarea" id="oppWhyUs" placeholder="What do we have (data, distribution, tech) that others don't?" oninput="updatePreview()" style="min-height:90px"></textarea>
        </div>
      </div>
    </div>
  </div>

</div>`;
}

// ─── RENDER ENGINE ────────────────────────────────────────────
function switchDoc(type, navEl, sideEl) {
  currentDoc = type;

  // Update nav tabs
  if (navEl) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    navEl.classList.add('active');
  }
  // Sync nav tab if triggered from sidebar
  if (!navEl) {
    document.querySelectorAll('.nav-tab').forEach(t => {
      t.classList.toggle('active', t.dataset.doc === type);
    });
  }
  // Update sidebar items
  document.querySelectorAll('.doc-type-item').forEach((el, i) => {
    el.classList.remove('active');
    const types = ['user-story','prd','roadmap','sprint','opp','gantt'];
  // Update nav center label
  const docLabels = {
    'user-story': 'User Story', 'prd': 'PRD', 'roadmap': 'Roadmap',
    'sprint': 'Sprint Plan', 'opp': 'Opportunity Brief', 'gantt': 'Gantt Chart'
  };
  const navLbl = document.getElementById('navDocLabel');
  if (navLbl) navLbl.innerHTML = docLabels[type] || type;
    if (types[i] === type) el.classList.add('active');
  });

  // Gantt mode: hide right preview panel, use full width
  const workspace = document.querySelector('.workspace');
  if (type === 'gantt') {
    workspace.classList.add('gantt-mode');
  } else {
    workspace.classList.remove('gantt-mode');
  }

  // Reset rows
  storyRows = [{ who: '', want: '', so: '' }];
  acceptanceRows = [''];
  sprintRows = [{ task: '', owner: '', points: '', status: 'todo' }];

  const templates = {
    'user-story': renderUserStory,
    'prd': renderPRD,
    'roadmap': renderRoadmap,
    'sprint': renderSprint,
    'opp': renderOpp,
    'gantt': renderGantt,
  };

  document.getElementById('editorArea').innerHTML = templates[type]();
  document.getElementById('tipCard').innerHTML = tips[type];

  // Render dynamic rows
  if (type === 'user-story') {
    renderStoryRows();
    renderAcceptanceRows();
  }
  if (type === 'sprint') {
    renderSprintRows();
  }
  if (type === 'gantt') {
    renderGanttChart();
  }

  // Animate
  document.querySelectorAll('.form-section').forEach((el, i) => {
    el.style.animationDelay = `${i * 0.06}s`;
  });

  selectedPriority = 'P3';
  if (type !== 'gantt') updatePreview();
  updateProgress();
  syncExportButtons();
}

// ─── STORY ROWS ───────────────────────────────────────────────
function renderStoryRows() {
  const container = document.getElementById('storyRows');
  if (!container) return;
  container.innerHTML = storyRows.map((row, i) => `
    <div class="story-row">
      <input placeholder="As a..." value="${row.who}" oninput="storyRows[${i}].who=this.value;updatePreview()">
      <span class="story-connector">I want to</span>
      <input placeholder="perform this action..." value="${row.want}" oninput="storyRows[${i}].want=this.value;updatePreview()">
      <span class="story-connector">so that</span>
      <input placeholder="I achieve this goal..." value="${row.so}" oninput="storyRows[${i}].so=this.value;updatePreview()">
      ${storyRows.length > 1 ? `<button class="remove-row-btn" onclick="removeStoryRow(${i})">×</button>` : ''}
    </div>
  `).join('');
}

function addStoryRow() {
  storyRows.push({ who: '', want: '', so: '' });
  renderStoryRows();
}

function removeStoryRow(i) {
  storyRows.splice(i, 1);
  renderStoryRows();
  updatePreview();
}

// ─── ACCEPTANCE ROWS ──────────────────────────────────────────
function renderAcceptanceRows() {
  const container = document.getElementById('acceptanceRows');
  if (!container) return;
  container.innerHTML = acceptanceRows.map((row, i) => `
    <div class="acceptance-row" style="margin-bottom:8px">
      <div class="ac-num">${i + 1}</div>
      <div style="display:flex;gap:8px;align-items:center">
        <textarea class="field-textarea" style="min-height:52px;flex:1" placeholder="Given [context], when [action], then [outcome]..." oninput="acceptanceRows[${i}]=this.value;updatePreview()">${row}</textarea>
        ${acceptanceRows.length > 1 ? `<button class="remove-row-btn" onclick="removeAcceptanceRow(${i})">×</button>` : ''}
      </div>
    </div>
  `).join('');
}

function addAcceptanceRow() {
  acceptanceRows.push('');
  renderAcceptanceRows();
}

function removeAcceptanceRow(i) {
  acceptanceRows.splice(i, 1);
  renderAcceptanceRows();
  updatePreview();
}

// ─── SPRINT ROWS ──────────────────────────────────────────────
function renderSprintRows() {
  const tbody = document.getElementById('sprintRows');
  if (!tbody) return;
  tbody.innerHTML = sprintRows.map((row, i) => `
    <tr>
      <td><input value="${row.task}" placeholder="Task or story name..." oninput="sprintRows[${i}].task=this.value;updatePreview()"></td>
      <td><input value="${row.owner}" placeholder="@name" style="max-width:90px" oninput="sprintRows[${i}].owner=this.value;updatePreview()"></td>
      <td><input value="${row.points}" placeholder="3" type="number" style="max-width:60px" oninput="sprintRows[${i}].points=this.value;updatePreview()"></td>
      <td>
        <select oninput="sprintRows[${i}].status=this.value;updatePreview()" style="font-family:'JetBrains Mono',monospace;font-size:10px;border:1px solid var(--border2);border-radius:6px;padding:4px 8px;background:var(--surface2);color:var(--ink2);cursor:pointer;outline:none;">
          <option ${row.status==='todo'?'selected':''}>todo</option>
          <option ${row.status==='in-progress'?'selected':''}>in-progress</option>
          <option ${row.status==='done'?'selected':''}>done</option>
          <option ${row.status==='blocked'?'selected':''}>blocked</option>
        </select>
      </td>
      <td>${sprintRows.length > 1 ? `<button class="remove-row-btn" onclick="removeSprintRow(${i})">×</button>` : ''}</td>
    </tr>
  `).join('');
}

function addSprintRow() {
  sprintRows.push({ task: '', owner: '', points: '', status: 'todo' });
  renderSprintRows();
}

function removeSprintRow(i) {
  sprintRows.splice(i, 1);
  renderSprintRows();
  updatePreview();
}

// ─── PRIORITY ─────────────────────────────────────────────────
let selectedPriority = 'P3';
function setPriority(p, el) {
  selectedPriority = p;
  document.querySelectorAll('.priority-pill').forEach(pill => {
    pill.className = 'priority-pill';
  });
  const classMap = { P0: 'sel-p0', P1: 'sel-p1', P2: 'sel-p2', P3: 'sel-p3' };
  el.classList.add(classMap[p]);
  updatePreview();
}

// ─── TOGGLE SECTION ───────────────────────────────────────────
function toggleSection(head) {
  const body = head.nextElementSibling;
  body.classList.toggle('collapsed');
  head.classList.toggle('open', !body.classList.contains('collapsed'));
  const svgEl = head.querySelector('.section-toggle svg');
  if (svgEl) svgEl.style.transform = body.classList.contains('collapsed') ? '' : 'rotate(180deg)';
}

// ─── AUTO RESIZE TEXTAREA ─────────────────────────────────────
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}

// ─── PROGRESS ─────────────────────────────────────────────────
function updateProgress() {
  setTimeout(() => {
    const inputs = document.querySelectorAll('.field-input, .field-textarea, .doc-title-input');
    let filled = 0;
    inputs.forEach(el => { if (el.value.trim()) filled++; });
    const total = inputs.length;
    const pct = total ? Math.round((filled / total) * 100) : 0;
    const fill = document.getElementById('progressFill');
    const label = document.getElementById('progressLabel');
    const pctEl = document.getElementById('progressPct');
    if (fill) fill.style.width = pct + '%';
    if (label) label.textContent = `${filled} of ${total} fields filled`;
    if (pctEl) pctEl.textContent = pct + '%';
  }, 100);
}

// ─── PREVIEW ──────────────────────────────────────────────────
function g(id) {
  const el = document.getElementById(id);
  return el ? el.value.trim() : '';
}

function updatePreview() {
  updateProgress();
  const preview = document.getElementById('previewDoc');
  if (!preview) return;

  let html = '';

  if (currentDoc === 'user-story') {
    const title = g('docTitle') || 'Untitled User Story';
    html += `<div class="preview-title-area">${title}</div>`;
    const meta = [g('metaAuthor'),g('metaEpic'),g('metaSprint'),selectedPriority].filter(Boolean).join(' · ');
    if (meta) html += `<div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:14px">${meta}</div>`;

    const validStories = storyRows.filter(r => r.want);
    if (validStories.length) {
      html += `<div class="preview-section"><div class="preview-section-title">USER STORIES</div><div class="preview-section-body">`;
      validStories.forEach(r => {
        html += `• As a <strong>${r.who || '…'}</strong>, I want to <strong>${r.want}</strong>, so that <strong>${r.so || '…'}</strong><br>`;
      });
      html += `</div></div>`;
    }
    const validAC = acceptanceRows.filter(Boolean);
    if (validAC.length) {
      html += `<div class="preview-section"><div class="preview-section-title">ACCEPTANCE CRITERIA</div><div class="preview-section-body">`;
      validAC.forEach((ac, i) => { html += `${i+1}. ${ac}<br>`; });
      html += `</div></div>`;
    }
    if (g('problemStatement')) html += `<div class="preview-section"><div class="preview-section-title">PROBLEM CONTEXT</div><div class="preview-section-body">${g('problemStatement')}</div></div>`;
    const sm = g('successMetric'), sp = g('storyPoints');
    if (sm || sp) html += `<div class="preview-section"><div class="preview-section-title">METRICS & SIZE</div><div class="preview-section-body">${sm ? `Success: ${sm}` : ''}${sm && sp ? ' · ' : ''}${sp ? `${sp} pts` : ''}</div></div>`;
    if (g('outOfScope')) html += `<div class="preview-section"><div class="preview-section-title">OUT OF SCOPE</div><div class="preview-section-body">${g('outOfScope')}</div></div>`;
    if (g('dependencies')) html += `<div class="preview-section"><div class="preview-section-title">DEPENDENCIES</div><div class="preview-section-body">${g('dependencies')}</div></div>`;
    if (g('notes')) html += `<div class="preview-section"><div class="preview-section-title">NOTES</div><div class="preview-section-body">${g('notes')}</div></div>`;
  }

  else if (currentDoc === 'prd') {
    const title = g('docTitle') || 'Untitled PRD';
    html += `<div class="preview-title-area">${title}</div>`;
    const meta = [g('metaAuthor'), g('metaVersion'), g('metaStatus')].filter(Boolean).join(' · ');
    if (meta) html += `<div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:14px">${meta}</div>`;
    if (g('prdProblem')) html += `<div class="preview-section"><div class="preview-section-title">PROBLEM</div><div class="preview-section-body">${g('prdProblem')}</div></div>`;
    const who = [g('prdUser'), g('prdImpact')].filter(Boolean).join(' — ');
    if (who) html += `<div class="preview-section"><div class="preview-section-title">TARGET USER</div><div class="preview-section-body">${who}</div></div>`;
    if (g('prdGoal')) html += `<div class="preview-section"><div class="preview-section-title">GOAL</div><div class="preview-section-body">${g('prdGoal')}</div></div>`;
    const metrics = [g('prdNSM') && `⭐ NSM: ${g('prdNSM')}`, g('prdGuardrail') && `🛡 Guardrail: ${g('prdGuardrail')}`].filter(Boolean).join('<br>');
    if (metrics) html += `<div class="preview-section"><div class="preview-section-title">METRICS</div><div class="preview-section-body">${metrics}</div></div>`;
    if (g('prdFunctional')) html += `<div class="preview-section"><div class="preview-section-title">FUNCTIONAL REQUIREMENTS</div><div class="preview-section-body">${g('prdFunctional')}</div></div>`;
    if (g('prdNonFunctional')) html += `<div class="preview-section"><div class="preview-section-title">NON-FUNCTIONAL REQUIREMENTS</div><div class="preview-section-body">${g('prdNonFunctional')}</div></div>`;
    if (g('prdOOS')) html += `<div class="preview-section"><div class="preview-section-title">OUT OF SCOPE</div><div class="preview-section-body">${g('prdOOS')}</div></div>`;
    if (g('prdRisks')) html += `<div class="preview-section"><div class="preview-section-title">RISKS</div><div class="preview-section-body">${g('prdRisks')}</div></div>`;
    const timeline = [g('prdLaunch') && `Launch: ${g('prdLaunch')}`, g('prdEng') && `Eng: ${g('prdEng')}`].filter(Boolean).join(' · ');
    if (timeline) html += `<div class="preview-section"><div class="preview-section-title">TIMELINE</div><div class="preview-section-body">${timeline}</div></div>`;
  }

  else if (currentDoc === 'roadmap') {
    const title = g('docTitle') || 'Product Roadmap';
    html += `<div class="preview-title-area">${title}</div>`;
    const meta = [g('metaTeam'), g('metaYear'), g('metaAuthor')].filter(Boolean).join(' · ');
    if (meta) html += `<div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:14px">${meta}</div>`;
    if (g('rdmVision')) html += `<div class="preview-section"><div class="preview-section-title">VISION</div><div class="preview-section-body"><em>${g('rdmVision')}</em></div></div>`;
    if (g('rdmBets')) html += `<div class="preview-section"><div class="preview-section-title">STRATEGIC BETS</div><div class="preview-section-body">${g('rdmBets')}</div></div>`;
    const quarters = ['Q1','Q2','Q3','Q4'];
    const qHtml = quarters.map(q => {
      const theme = g(`rdm${q}Theme`), items = g(`rdm${q}Items`), status = (document.getElementById(`rdm${q}Status`) || {}).value || '';
      if (!theme) return '';
      return `<strong>${q} — ${theme}</strong>${status ? ` [${status}]` : ''}<br>${items ? items + '<br>' : ''}`;
    }).filter(Boolean).join('<br>');
    if (qHtml) html += `<div class="preview-section"><div class="preview-section-title">QUARTERLY PLAN</div><div class="preview-section-body">${qHtml}</div></div>`;
    if (g('rdmObj')) html += `<div class="preview-section"><div class="preview-section-title">OBJECTIVE</div><div class="preview-section-body">${g('rdmObj')}</div></div>`;
    if (g('rdmKRs')) html += `<div class="preview-section"><div class="preview-section-title">KEY RESULTS</div><div class="preview-section-body">${g('rdmKRs')}</div></div>`;
  }

  else if (currentDoc === 'sprint') {
    const title = g('docTitle') || 'Sprint Plan';
    html += `<div class="preview-title-area">${title}</div>`;
    const meta = [g('metaSprint'), g('metaTeam'), g('metaStart') && g('metaEnd') ? `${g('metaStart')} → ${g('metaEnd')}` : ''].filter(Boolean).join(' · ');
    if (meta) html += `<div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:14px">${meta}</div>`;
    if (g('sprintGoal')) html += `<div class="preview-section"><div class="preview-section-title">SPRINT GOAL</div><div class="preview-section-body"><strong>${g('sprintGoal')}</strong></div></div>`;
    const cap = [g('sprintCapacity') && `Capacity: ${g('sprintCapacity')} pts`, g('sprintSuccess') && `Signal: ${g('sprintSuccess')}`].filter(Boolean).join(' · ');
    if (cap) html += `<div class="preview-section"><div class="preview-section-title">CAPACITY & SUCCESS SIGNAL</div><div class="preview-section-body">${cap}</div></div>`;
    const validTasks = sprintRows.filter(r => r.task);
    if (validTasks.length) {
      const totalPts = validTasks.reduce((s, r) => s + (parseInt(r.points)||0), 0);
      html += `<div class="preview-section"><div class="preview-section-title">BACKLOG (${validTasks.length} tasks · ${totalPts} pts)</div><div class="preview-section-body">`;
      validTasks.forEach(r => {
        html += `[${r.status.toUpperCase()}] ${r.task}${r.owner ? ` — ${r.owner}` : ''}${r.points ? ` (${r.points}pts)` : ''}<br>`;
      });
      html += `</div></div>`;
    }
    if (g('carryover')) html += `<div class="preview-section"><div class="preview-section-title">CARRY-OVER</div><div class="preview-section-body">${g('carryover')}</div></div>`;
    if (g('blockers')) html += `<div class="preview-section"><div class="preview-section-title">BLOCKERS</div><div class="preview-section-body">${g('blockers')}</div></div>`;
  }

  else if (currentDoc === 'opp') {
    const title = g('docTitle') || 'Opportunity Brief';
    html += `<div class="preview-title-area">${title}</div>`;
    const meta = [g('metaAuthor'), g('metaConfidence')].filter(Boolean).join(' · ');
    if (meta) html += `<div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:14px">${meta}</div>`;
    if (g('oppWho')) html += `<div class="preview-section"><div class="preview-section-title">WHO HAS THIS PROBLEM</div><div class="preview-section-body">${g('oppWho')}</div></div>`;
    if (g('oppWhat')) html += `<div class="preview-section"><div class="preview-section-title">THE PROBLEM</div><div class="preview-section-body">${g('oppWhat')}</div></div>`;
    const size = [g('oppSize') && `Scale: ${g('oppSize')}`, g('oppEvidence') && `Evidence: ${g('oppEvidence')}`].filter(Boolean).join('<br>');
    if (size) html += `<div class="preview-section"><div class="preview-section-title">SCALE & EVIDENCE</div><div class="preview-section-body">${size}</div></div>`;
    if (g('oppStatement')) html += `<div class="preview-section"><div class="preview-section-title">OPPORTUNITY</div><div class="preview-section-body"><strong>${g('oppStatement')}</strong></div></div>`;
    const biz = [g('oppBizImpact') && `Impact: ${g('oppBizImpact')}`, g('oppStrategic') && `Fit: ${g('oppStrategic')}`].filter(Boolean).join('<br>');
    if (biz) html += `<div class="preview-section"><div class="preview-section-title">BUSINESS VALUE</div><div class="preview-section-body">${biz}</div></div>`;
    if (g('oppSolutions')) html += `<div class="preview-section"><div class="preview-section-title">SOLUTION SPACE</div><div class="preview-section-body">${g('oppSolutions')}</div></div>`;
    if (g('oppValidation')) html += `<div class="preview-section"><div class="preview-section-title">VALIDATION NEEDED</div><div class="preview-section-body">${g('oppValidation')}</div></div>`;
    if (g('oppWhyNow')) html += `<div class="preview-section"><div class="preview-section-title">WHY NOW</div><div class="preview-section-body">${g('oppWhyNow')}</div></div>`;
    if (g('oppWhyUs')) html += `<div class="preview-section"><div class="preview-section-title">WHY US</div><div class="preview-section-body">${g('oppWhyUs')}</div></div>`;
  }

  preview.innerHTML = html || `<div class="preview-empty">Start filling in the form to see your document take shape...</div>`;
}

// ─── EXPORT ENGINE ────────────────────────────────────────────

// Per-doc export definitions
const EXPORT_CONFIG = {
  'user-story': {
    label: 'User Story',
    color: 'var(--green)',
    downloads: [
      { id:'pdf',  icon:'🖨', bg:'#fceef1', name:'PDF',           desc:'Print-ready document',         badge:'download' },
      { id:'docx', icon:'📄', bg:'#e8f0fe', name:'Word (.docx)',  desc:'Editable Word document',       badge:'download' },
      { id:'json', icon:'{ }',bg:'#f0fdf4', name:'JSON',          desc:'Import to Jira / Linear / Asana', badge:'download' },
    ],
    tools: [
      { id:'jira',    icon:'🟦', bg:'#deebff', name:'Jira',          desc:'Open as new issue template',  badge:'open',   url:'https://jira.atlassian.com' },
      { id:'linear',  icon:'⚫', bg:'#f3f0ff', name:'Linear',         desc:'Paste into new issue',        badge:'copy',   url:'https://linear.app' },
      { id:'asana',   icon:'🟥', bg:'#fff0f0', name:'Asana',          desc:'Create task from this story', badge:'open',   url:'https://app.asana.com' },
      { id:'gdoc',    icon:'📝', bg:'#e6f4ea', name:'Google Docs',    desc:'Open and paste content',      badge:'copy',   url:'https://docs.new' },
    ]
  },
  'prd': {
    label: 'PRD',
    color: 'var(--slate)',
    downloads: [
      { id:'pdf',  icon:'🖨', bg:'#fceef1', name:'PDF',           desc:'Shareable PDF document',       badge:'download' },
      { id:'docx', icon:'📄', bg:'#e8f0fe', name:'Word (.docx)',  desc:'Editable Word document',       badge:'download' },
      { id:'json', icon:'{ }',bg:'#f0fdf4', name:'JSON',          desc:'Import to Notion / Confluence', badge:'download' },
    ],
    tools: [
      { id:'notion',     icon:'⬛', bg:'#f4f4f4', name:'Notion',        desc:'Paste into a Notion page',    badge:'copy',   url:'https://notion.so' },
      { id:'confluence', icon:'🔵', bg:'#deebff', name:'Confluence',    desc:'Create page from template',   badge:'open',   url:'https://confluence.atlassian.com' },
      { id:'gdoc',       icon:'📝', bg:'#e6f4ea', name:'Google Docs',   desc:'Open new doc and paste',      badge:'copy',   url:'https://docs.new' },
      { id:'gslides',    icon:'🟧', bg:'#fff3e8', name:'Google Slides', desc:'Present your PRD',            badge:'copy',   url:'https://slides.new' },
    ]
  },
  'roadmap': {
    label: 'Roadmap',
    color: 'var(--amber)',
    downloads: [
      { id:'pdf',  icon:'🖨', bg:'#fceef1', name:'PDF',           desc:'Shareable roadmap PDF',        badge:'download' },
      { id:'pptx', icon:'📊', bg:'#fff3e8', name:'PowerPoint',    desc:'Slide deck (.html → pptx)',    badge:'download' },
      { id:'json', icon:'{ }',bg:'#f0fdf4', name:'JSON',          desc:'Import to Productboard / Miro', badge:'download' },
    ],
    tools: [
      { id:'figjam',      icon:'🎨', bg:'#fff0f6', name:'FigJam',       desc:'Build visual roadmap board',   badge:'open',  url:'https://www.figma.com/figjam/' },
      { id:'miro',        icon:'🟡', bg:'#fff9e6', name:'Miro',          desc:'Collaborative roadmap board',  badge:'open',  url:'https://miro.com/app/board/new/' },
      { id:'productboard',icon:'🟣', bg:'#f3f0ff', name:'Productboard',  desc:'Import items to roadmap',     badge:'open',  url:'https://app.productboard.com' },
      { id:'gslides',     icon:'🟧', bg:'#fff3e8', name:'Google Slides', desc:'Present the roadmap',         badge:'copy',  url:'https://slides.new' },
    ]
  },
  'sprint': {
    label: 'Sprint Plan',
    color: 'var(--rose)',
    downloads: [
      { id:'pdf',  icon:'🖨', bg:'#fceef1', name:'PDF',           desc:'Printable sprint plan',        badge:'download' },
      { id:'csv',  icon:'📊', bg:'#e8f5e9', name:'Excel / CSV',   desc:'Task table spreadsheet',       badge:'download' },
      { id:'json', icon:'{ }',bg:'#f0fdf4', name:'JSON',          desc:'Import to Jira / ADO / Notion', badge:'download' },
    ],
    tools: [
      { id:'jira',    icon:'🟦', bg:'#deebff', name:'Jira Board',     desc:'Set up sprint in Jira',         badge:'open',  url:'https://jira.atlassian.com' },
      { id:'ado',     icon:'🔷', bg:'#e8f0ff', name:'Azure DevOps',   desc:'Import to ADO sprint board',    badge:'open',  url:'https://dev.azure.com' },
      { id:'gsheet',  icon:'🟩', bg:'#e6f4ea', name:'Google Sheets',  desc:'Open task list in Sheets',      badge:'copy',  url:'https://sheets.new' },
      { id:'notion',  icon:'⬛', bg:'#f4f4f4', name:'Notion',         desc:'Paste into sprint board',       badge:'copy',  url:'https://notion.so' },
    ]
  },
  'opp': {
    label: 'Opportunity Brief',
    color: 'var(--violet)',
    downloads: [
      { id:'pdf',  icon:'🖨', bg:'#fceef1', name:'PDF',           desc:'Shareable brief PDF',          badge:'download' },
      { id:'docx', icon:'📄', bg:'#e8f0fe', name:'Word (.docx)',  desc:'Editable Word document',       badge:'download' },
      { id:'json', icon:'{ }',bg:'#f0fdf4', name:'JSON',          desc:'Import to Notion / Slite',     badge:'download' },
    ],
    tools: [
      { id:'notion', icon:'⬛', bg:'#f4f4f4', name:'Notion',       desc:'Paste into Notion page',       badge:'copy',  url:'https://notion.so' },
      { id:'slite',  icon:'🟦', bg:'#e8f4ff', name:'Slite',        desc:'Create note in Slite',         badge:'open',  url:'https://slite.com' },
      { id:'gdoc',   icon:'📝', bg:'#e6f4ea', name:'Google Docs',  desc:'Open new doc and paste',       badge:'copy',  url:'https://docs.new' },
      { id:'loom',   icon:'🟣', bg:'#f3f0ff', name:'Loom',         desc:'Record a walkthrough video',   badge:'open',  url:'https://loom.com/new' },
    ]
  },
  'gantt': {
    label: 'Gantt Chart',
    color: '#0d7a72',
    downloads: [
      { id:'pdf',  icon:'🖨', bg:'#fceef1', name:'PDF',           desc:'Print-ready Gantt chart',      badge:'download' },
      { id:'csv',  icon:'📊', bg:'#e8f5e9', name:'Excel / CSV',   desc:'Task data spreadsheet',        badge:'download' },
      { id:'json', icon:'{ }',bg:'#f0fdf4', name:'JSON',          desc:'Import to GanttPRO / Notion',  badge:'download' },
    ],
    tools: [
      { id:'ganttpro',  icon:'🟦', bg:'#e8f4ff', name:'GanttPRO',     desc:'Import to GanttPRO',            badge:'open',  url:'https://app.ganttpro.com' },
      { id:'timeline',  icon:'🟩', bg:'#e6f4ea', name:'Timeline View', desc:'Google Sheets timeline',        badge:'copy',  url:'https://sheets.new' },
      { id:'gsheet',    icon:'🟩', bg:'#e6f4ea', name:'Google Sheets', desc:'Open task data in Sheets',      badge:'copy',  url:'https://sheets.new' },
      { id:'notion',    icon:'⬛', bg:'#f4f4f4', name:'Notion',        desc:'Paste timeline into Notion',    badge:'copy',  url:'https://notion.so' },
    ]
  }
};

// ── Modal open/close ──────────────────────────────────────────
function openExportModal() {
  const config = EXPORT_CONFIG[currentDoc];
  if (!config) return;

  const titleEl = document.getElementById('docTitle');
  const docName = (titleEl ? titleEl.value.trim() : '') || config.label;

  const toolRows = config.tools.map(t => `
    <button class="modal-export-btn" onclick="handleToolExport('${t.id}','${t.url}','${t.badge}');closeExportModal()">
      <div class="meb-icon" style="background:${t.bg}">${t.icon}</div>
      <div class="meb-text">
        <div class="meb-name">${t.name}</div>
        <div class="meb-desc">${t.desc}</div>
      </div>
      <span class="meb-badge ${t.badge}">${t.badge === 'download' ? '⬇ download' : t.badge === 'copy' ? '📋 copy+open' : '↗ open'}</span>
    </button>`).join('');

  const dlRows = config.downloads.map(d => `
    <button class="modal-export-btn primary-action" onclick="handleDownloadExport('${d.id}');closeExportModal()">
      <div class="meb-icon" style="background:${d.bg}">${d.icon}</div>
      <div class="meb-text">
        <div class="meb-name">${d.name}</div>
        <div class="meb-desc">${d.desc}</div>
      </div>
      <span class="meb-badge download">⬇ download</span>
    </button>`).join('');

  const modal = document.createElement('div');
  modal.className = 'export-modal-overlay';
  modal.id = 'exportModalOverlay';
  modal.onclick = (e) => { if (e.target === modal) closeExportModal(); };
  modal.innerHTML = `
    <div class="export-modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">Export "${docName}"</div>
          <div class="modal-subtitle">${config.label} · Choose your format or destination</div>
        </div>
        <button class="modal-close" onclick="closeExportModal()">✕</button>
      </div>

      <div class="modal-section-label" style="margin-bottom:10px">⬇ Download File</div>
      <div class="modal-btn-grid g${config.downloads.length === 1 ? '1' : '2'}" style="margin-bottom:18px">
        ${dlRows}
      </div>

      <div class="modal-section-label" style="margin-bottom:10px">↗ Open in Tool</div>
      <div class="modal-btn-grid g${config.tools.length > 2 ? '2' : '1'}">
        ${toolRows}
      </div>
    </div>`;

  document.body.appendChild(modal);
  // trap escape
  document.addEventListener('keydown', handleModalEsc);
}

function closeExportModal() {
  const m = document.getElementById('exportModalOverlay');
  if (m) m.remove();
  document.removeEventListener('keydown', handleModalEsc);
}

function handleModalEsc(e) {
  if (e.key === 'Escape') closeExportModal();
}

// ── Download handlers ─────────────────────────────────────────
function handleDownloadExport(format) {
  if (format === 'pdf')  exportPDF();
  else if (format === 'docx') exportDOCX();
  else if (format === 'csv')  exportCSV();
  else if (format === 'pptx') exportPPTX();
  else if (format === 'json') exportJSON();
}

// ── JSON Export — structured schema per doc type ──────────────
function exportJSON() {
  let data = {};
  const titleEl = document.getElementById('docTitle');
  const docTitle = (titleEl ? titleEl.value.trim() : '') || currentDoc;
  const ts = new Date().toISOString();

  if (currentDoc === 'user-story') {
    data = {
      schema: 'pm-docstudio/user-story@1.0',
      exportedAt: ts,
      metadata: {
        title:    docTitle,
        author:   (document.getElementById('metaAuthor')||{}).value || '',
        epic:     (document.getElementById('metaEpic')||{}).value   || '',
        sprint:   (document.getElementById('metaSprint')||{}).value || '',
        priority: selectedPriority,
        storyPoints: parseInt((document.getElementById('storyPoints')||{}).value) || null,
      },
      stories: storyRows.filter(r => r.want).map((r,i) => ({
        id: `US-${i+1}`,
        asA:    r.who,
        iWant:  r.want,
        soThat: r.so,
      })),
      acceptanceCriteria: acceptanceRows.filter(Boolean).map((ac,i) => ({
        id: `AC-${i+1}`,
        criterion: ac,
      })),
      context: {
        problemStatement: (document.getElementById('problemStatement')||{}).value || '',
        successMetric:    (document.getElementById('successMetric')||{}).value    || '',
        outOfScope:       (document.getElementById('outOfScope')||{}).value       || '',
        dependencies:     (document.getElementById('dependencies')||{}).value     || '',
        notes:            (document.getElementById('notes')||{}).value            || '',
      },
      // Jira-compatible fields
      jiraCompatible: {
        issueType: 'Story',
        summary:   docTitle,
        labels:    ['pm-docstudio'],
        priority:  selectedPriority,
        description: storyRows.filter(r=>r.want).map(r =>
          `*As a* ${r.who}, *I want to* ${r.want}, *so that* ${r.so}`).join('\n'),
        acceptanceCriteria: acceptanceRows.filter(Boolean).join('\n'),
      }
    };
  }

  else if (currentDoc === 'prd') {
    data = {
      schema: 'pm-docstudio/prd@1.0',
      exportedAt: ts,
      metadata: {
        title:    docTitle,
        author:   (document.getElementById('metaAuthor')||{}).value  || '',
        version:  (document.getElementById('metaVersion')||{}).value || 'v1.0',
        date:     (document.getElementById('metaDate')||{}).value    || '',
        status:   (document.getElementById('metaStatus')||{}).value  || 'Draft',
      },
      problem: {
        statement:  (document.getElementById('prdProblem')||{}).value    || '',
        targetUser: (document.getElementById('prdUser')||{}).value       || '',
        userImpact: (document.getElementById('prdImpact')||{}).value     || '',
      },
      goals: {
        primaryGoal:      (document.getElementById('prdGoal')||{}).value      || '',
        northStarMetric:  (document.getElementById('prdNSM')||{}).value       || '',
        guardrailMetric:  (document.getElementById('prdGuardrail')||{}).value || '',
        supportingMetrics:(document.getElementById('prdMetrics')||{}).value   || '',
      },
      requirements: {
        functional:    (document.getElementById('prdFunctional')||{}).value    || '',
        nonFunctional: (document.getElementById('prdNonFunctional')||{}).value || '',
      },
      scope: {
        outOfScope:  (document.getElementById('prdOOS')||{}).value        || '',
        assumptions: (document.getElementById('prdAssumptions')||{}).value || '',
      },
      delivery: {
        targetLaunch: (document.getElementById('prdLaunch')||{}).value || '',
        engOwner:     (document.getElementById('prdEng')||{}).value    || '',
        risks:        (document.getElementById('prdRisks')||{}).value  || '',
      },
      // Notion-compatible page properties
      notionCompatible: {
        title:  docTitle,
        status: (document.getElementById('metaStatus')||{}).value || 'Draft',
        owner:  (document.getElementById('metaAuthor')||{}).value || '',
        tags:   ['PRD','pm-docstudio'],
      }
    };
  }

  else if (currentDoc === 'roadmap') {
    const quarters = ['Q1','Q2','Q3','Q4'].map(q => ({
      quarter: q,
      theme:  (document.getElementById(`rdm${q}Theme`)||{}).value  || '',
      items:  (document.getElementById(`rdm${q}Items`)||{}).value  || '',
      status: (document.getElementById(`rdm${q}Status`)||{}).value || 'Planned',
    })).filter(q => q.theme);
    data = {
      schema: 'pm-docstudio/roadmap@1.0',
      exportedAt: ts,
      metadata: {
        title:  docTitle,
        team:   (document.getElementById('metaTeam')||{}).value   || '',
        year:   (document.getElementById('metaYear')||{}).value   || '',
        author: (document.getElementById('metaAuthor')||{}).value || '',
      },
      vision: {
        statement:     (document.getElementById('rdmVision')||{}).value || '',
        strategicBets: (document.getElementById('rdmBets')||{}).value   || '',
      },
      quarters,
      okrs: {
        objective:  (document.getElementById('rdmObj')||{}).value  || '',
        keyResults: (document.getElementById('rdmKRs')||{}).value  || '',
      },
      dependencies: (document.getElementById('rdmDeps')||{}).value  || '',
      risks:        (document.getElementById('rdmRisks')||{}).value || '',
      // Productboard-compatible structure
      productboardCompatible: {
        initiatives: quarters.map(q => ({
          name:   `${q.quarter}: ${q.theme}`,
          status: q.status,
          description: q.items,
          timeframe: q.quarter,
        }))
      }
    };
  }

  else if (currentDoc === 'sprint') {
    const tasks = sprintRows.filter(r => r.task);
    const totalPts = tasks.reduce((s,r) => s + (parseInt(r.points)||0), 0);
    data = {
      schema: 'pm-docstudio/sprint-plan@1.0',
      exportedAt: ts,
      metadata: {
        title:    docTitle,
        sprint:   (document.getElementById('metaSprint')||{}).value || '',
        team:     (document.getElementById('metaTeam')||{}).value   || '',
        startDate:(document.getElementById('metaStart')||{}).value  || '',
        endDate:  (document.getElementById('metaEnd')||{}).value    || '',
        capacity: parseInt((document.getElementById('sprintCapacity')||{}).value) || null,
      },
      goal: {
        statement:     (document.getElementById('sprintGoal')||{}).value    || '',
        successSignal: (document.getElementById('sprintSuccess')||{}).value || '',
      },
      backlog: tasks.map((r,i) => ({
        id:     `TASK-${i+1}`,
        title:  r.task,
        owner:  r.owner,
        points: parseInt(r.points) || 0,
        status: r.status,
      })),
      summary: {
        totalTasks:  tasks.length,
        totalPoints: totalPts,
        completedPoints: tasks.filter(r=>r.status==='done').reduce((s,r)=>s+(parseInt(r.points)||0),0),
      },
      carryover: (document.getElementById('carryover')||{}).value || '',
      blockers:  (document.getElementById('blockers')||{}).value  || '',
      // Jira-compatible sprint structure
      jiraCompatible: {
        sprintName: (document.getElementById('metaSprint')||{}).value || docTitle,
        sprintGoal: (document.getElementById('sprintGoal')||{}).value || '',
        issues: tasks.map((r,i) => ({
          issueType: 'Task',
          summary:   r.task,
          assignee:  r.owner,
          storyPoints: parseInt(r.points) || 0,
          status:    r.status === 'todo' ? 'To Do' : r.status === 'in-progress' ? 'In Progress' : r.status === 'done' ? 'Done' : 'Blocked',
        }))
      }
    };
  }

  else if (currentDoc === 'opp') {
    data = {
      schema: 'pm-docstudio/opportunity-brief@1.0',
      exportedAt: ts,
      metadata: {
        title:      docTitle,
        author:     (document.getElementById('metaAuthor')||{}).value     || '',
        date:       (document.getElementById('metaDate')||{}).value       || '',
        confidence: (document.getElementById('metaConfidence')||{}).value || '',
      },
      problem: {
        who:      (document.getElementById('oppWho')||{}).value      || '',
        what:     (document.getElementById('oppWhat')||{}).value     || '',
        scale:    (document.getElementById('oppSize')||{}).value     || '',
        evidence: (document.getElementById('oppEvidence')||{}).value || '',
      },
      opportunity: {
        statement:    (document.getElementById('oppStatement')||{}).value  || '',
        businessImpact:(document.getElementById('oppBizImpact')||{}).value || '',
        strategicFit: (document.getElementById('oppStrategic')||{}).value  || '',
      },
      solutionSpace: {
        approaches:  (document.getElementById('oppSolutions')||{}).value  || '',
        validation:  (document.getElementById('oppValidation')||{}).value || '',
      },
      timing: {
        whyNow: (document.getElementById('oppWhyNow')||{}).value || '',
        whyUs:  (document.getElementById('oppWhyUs')||{}).value  || '',
      },
      // Notion-compatible
      notionCompatible: {
        title:      docTitle,
        confidence: (document.getElementById('metaConfidence')||{}).value || '',
        owner:      (document.getElementById('metaAuthor')||{}).value     || '',
        tags:       ['Opportunity','pm-docstudio'],
      }
    };
  }

  else if (currentDoc === 'gantt') {
    const statusLabels = { notstarted:'Not Started', inprogress:'In Progress', done:'Done', atrisk:'At Risk', blocked:'Blocked' };
    data = {
      schema: 'pm-docstudio/gantt@1.0',
      exportedAt: ts,
      metadata: {
        title:     docTitle,
        author:    (document.getElementById('ganttAuthor')||{}).value    || '',
        startDate: (document.getElementById('ganttStartDate')||{}).value || '',
        weeks:     ganttWeeks,
        todayWeek: ganttTodayWeek,
      },
      tasks: ganttTasks.map((t,i) => ({
        id:       `T-${i+1}`,
        name:     t.name,
        owner:    t.owner,
        startWeek:t.start,
        endWeek:  t.start + t.dur - 1,
        duration: t.dur,
        status:   statusLabels[t.status] || t.status,
        statusCode: t.status,
        progress: t.pct,
        color:    t.color,
      })),
      summary: {
        totalTasks:   ganttTasks.length,
        completed:    ganttTasks.filter(t=>t.status==='done').length,
        inProgress:   ganttTasks.filter(t=>t.status==='inprogress').length,
        atRiskBlocked:ganttTasks.filter(t=>t.status==='atrisk'||t.status==='blocked').length,
        avgProgress:  ganttTasks.length ? Math.round(ganttTasks.reduce((s,t)=>s+t.pct,0)/ganttTasks.length) : 0,
      },
      // GanttPRO-compatible structure
      ganttProCompatible: {
        tasks: ganttTasks.map((t,i) => ({
          id:        i+1,
          text:      t.name,
          start_date:`Week ${t.start}`,
          duration:  t.dur,
          progress:  t.pct / 100,
          owner:     t.owner,
        }))
      }
    };
  }

  const json = JSON.stringify(data, null, 2);
  downloadFile(getFilename('json'), json, 'application/json;charset=utf-8;');
  showToast(`✓ JSON exported — importable to ${EXPORT_CONFIG[currentDoc]?.label || 'your tools'}!`);
}

// PDF — opens clean print-ready window
function exportPDF() {
  const titleEl = document.getElementById('docTitle');
  const title = (titleEl ? titleEl.value.trim() : '') || currentDoc;
  const printWin = window.open('', '_blank');
  if (!printWin) { showToast('⚠ Pop-up blocked — please allow pop-ups'); return; }
  printWin.document.write(buildPrintHTML(title));
  printWin.document.close();
  printWin.onload = () => { printWin.focus(); printWin.print(); };
  showToast('🖨 Print dialog opened — choose "Save as PDF"');
}

// DOCX — generates a proper RTF file that Word opens natively
function exportDOCX() {
  const titleEl = document.getElementById('docTitle');
  const title = (titleEl ? titleEl.value.trim() : '') || currentDoc;
  const bodyContent = buildDocxRTFBody();
  // RTF format — opens in Word, Pages, LibreOffice
  const rtf = `{\\rtf1\\ansi\\deff0
{\\fonttbl{\\f0\\froman\\fcharset0 Times New Roman;}{\\f1\\fswiss\\fcharset0 Calibri;}{\\f2\\fmodern\\fcharset0 Courier New;}}
{\\colortbl;\\red24\\green20\\blue15;\\red156\\green144\\blue133;\\red30\\green122\\blue90;}
\\paperw12240\\paperh15840\\margl1800\\margr1800\\margt1440\\margb1440
${bodyContent}
}`;
  downloadFile(getFilename('rtf'), rtf, 'application/rtf');
  showToast('✓ Word document downloaded! Open in Word or Google Docs.');
}

// Build RTF body from preview
function buildDocxRTFBody() {
  if (currentDoc === 'gantt') {
    const titleEl = document.getElementById('docTitle');
    const title = (titleEl ? titleEl.value.trim() : '') || 'Gantt Chart';
    const statusLabels = { notstarted:'Not Started', inprogress:'In Progress', done:'Done', atrisk:'At Risk', blocked:'Blocked' };
    let rtf = `\\f1\\fs40\\b ${escRTF(title)}\\b0\\par\\pard\\par`;
    rtf += `\\f2\\fs18\\cf2 TASK TIMELINE\\cf1\\par\\pard`;
    rtf += `\\trowd\\trgaph108\\cellx2880\\cellx4320\\cellx5400\\cellx6480\\cellx7920\\cellx8640\n`;
    rtf += `\\b Task\\cell Owner\\cell Start\\cell Duration\\cell Status\\cell Done\\cell\\b0\\row\n`;
    ganttTasks.forEach(t => {
      rtf += `\\trowd\\trgaph108\\cellx2880\\cellx4320\\cellx5400\\cellx6480\\cellx7920\\cellx8640\n`;
      rtf += `${escRTF(t.name)}\\cell ${escRTF(t.owner)}\\cell Wk ${t.start}\\cell ${t.dur}w\\cell ${statusLabels[t.status]||t.status}\\cell ${t.pct}%\\cell\\row\n`;
    });
    rtf += `\\pard\\par`;
    return rtf;
  }

  const preview = document.getElementById('previewDoc');
  if (!preview) return '\\f1\\fs24 No content yet.\\par';
  let rtf = '';
  const titleEl2 = preview.querySelector('.preview-title-area');
  if (titleEl2) rtf += `\\f1\\fs40\\b ${escRTF(titleEl2.innerText.trim())}\\b0\\par\\pard\\par\n`;
  const metaEl = preview.querySelector('[style*="IBM Plex Mono"]');
  if (metaEl) rtf += `\\f2\\fs18\\cf2 ${escRTF(metaEl.innerText.trim())}\\cf1\\par\\pard\\par\n`;
  preview.querySelectorAll('.preview-section').forEach(sec => {
    const heading = sec.querySelector('.preview-section-title');
    const body    = sec.querySelector('.preview-section-body');
    if (heading) rtf += `\\f2\\fs18\\cf2 ${escRTF(heading.innerText.trim())}\\cf1\\par\\pard\n`;
    if (body) {
      const lines = body.innerText.trim().split('\n');
      lines.forEach(line => {
        if (line.trim()) rtf += `\\f1\\fs24 ${escRTF(line.trim())}\\par\n`;
      });
      rtf += `\\par\n`;
    }
  });
  return rtf || '\\f1\\fs24 No content yet.\\par';
}

function escRTF(str) {
  return (str || '').replace(/\\/g,'\\\\').replace(/\{/g,'\\{').replace(/\}/g,'\\}')
    .replace(/[^\x00-\x7F]/g, c => `\\u${c.charCodeAt(0)}?`);
}

// CSV — sprint tasks or gantt tasks
function exportCSV() {
  let content = '';
  if (currentDoc === 'gantt') {
    const header = 'Task,Owner,Start Week,Duration (wks),End Week,Status,% Done\n';
    const rows = ganttTasks.map(t => {
      const statusLabels = { notstarted:'Not Started', inprogress:'In Progress', done:'Done', atrisk:'At Risk', blocked:'Blocked' };
      return `"${t.name}","${t.owner}",${t.start},${t.dur},${t.start+t.dur-1},"${statusLabels[t.status]||t.status}",${t.pct}%`;
    }).join('\n');
    content = header + rows;
    showToast('✓ Gantt exported as Excel/CSV!');
  } else if (currentDoc === 'sprint') {
    content = 'Task,Owner,Story Points,Status\n';
    content += sprintRows.filter(r=>r.task).map(r =>
      `"${r.task}","${r.owner}",${r.points},"${r.status}"`).join('\n');
    const goal = (document.getElementById('sprintGoal')||{}).value||'';
    if (goal) content = `Sprint Goal,"${goal}"\n\n` + content;
    showToast('✓ Sprint plan exported as Excel/CSV!');
  }
  if (content) downloadFile(getFilename('csv'), content, 'text/csv;charset=utf-8;');
}

// PPTX — exports as a clean HTML slide deck (opens in browser, printable as PPTX-like)
function exportPPTX() {
  const titleEl = document.getElementById('docTitle');
  const title = (titleEl ? titleEl.value.trim() : '') || 'Roadmap';
  const html = buildSlideDeckHTML(title);
  downloadFile(getFilename('html'), html, 'text/html;charset=utf-8;');
  showToast('✓ Slide deck downloaded! Open in browser, then File → Print → Save PDF, or paste into PowerPoint.');
}

function buildSlideDeckHTML(title) {
  const slides = [];
  // Title slide
  const team = (document.getElementById('metaTeam')||{}).value || '';
  const yr   = (document.getElementById('metaYear')||{}).value || '';
  slides.push(`<div class="slide title-slide"><div class="slide-inner"><div class="slide-eyebrow">Product Roadmap</div><h1>${title}</h1><p class="slide-meta">${[team,yr].filter(Boolean).join(' · ')}</p></div></div>`);
  // Vision slide
  const vision = (document.getElementById('rdmVision')||{}).value||'';
  const bets   = (document.getElementById('rdmBets')||{}).value||'';
  if (vision||bets) slides.push(`<div class="slide"><div class="slide-inner"><div class="slide-label">Vision & Strategy</div><h2>${vision||'Our Vision'}</h2>${bets?`<ul>${bets.split('\n').filter(Boolean).map(b=>`<li>${b.trim()}</li>`).join('')}</ul>`:''}</div></div>`);
  // Q slides
  ['Q1','Q2','Q3','Q4'].forEach(q => {
    const theme = (document.getElementById(`rdm${q}Theme`)||{}).value||'';
    const items = (document.getElementById(`rdm${q}Items`)||{}).value||'';
    const status= (document.getElementById(`rdm${q}Status`)||{}).value||'Planned';
    if (theme) slides.push(`<div class="slide"><div class="slide-inner"><div class="slide-label">${q} · ${status}</div><h2>${theme}</h2>${items?`<ul>${items.split(/[,\n]/).filter(Boolean).map(i=>`<li>${i.trim()}</li>`).join('')}</ul>`:''}</div></div>`);
  });
  // OKR slide
  const obj = (document.getElementById('rdmObj')||{}).value||'';
  const krs  = (document.getElementById('rdmKRs')||{}).value||'';
  if (obj||krs) slides.push(`<div class="slide"><div class="slide-inner"><div class="slide-label">OKRs</div><h2>${obj}</h2>${krs?`<ul>${krs.split('\n').filter(Boolean).map(k=>`<li>${k.trim()}</li>`).join('')}</ul>`:''}</div></div>`);

  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Outfit',sans-serif;background:#111;display:flex;flex-direction:column;gap:0;align-items:center;padding:40px 20px}
.slide{width:960px;height:540px;background:#faf8f5;border-radius:12px;margin-bottom:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 32px rgba(0,0,0,0.4);overflow:hidden;position:relative}
.slide::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 80% 20%,rgba(30,122,90,0.06),transparent 60%)}
.slide-inner{padding:60px 72px;width:100%}
.title-slide{background:linear-gradient(135deg,#18140f 60%,#2a2010)}
.title-slide h1{font-family:'Fraunces',serif;font-size:52px;font-weight:700;color:#f0ece6;letter-spacing:-0.02em;line-height:1.1;margin:12px 0}
.title-slide .slide-eyebrow{font-family:'Courier New',monospace;font-size:11px;letter-spacing:0.2em;text-transform:uppercase;color:#9c9085;margin-bottom:8px}
.title-slide .slide-meta{font-size:16px;color:#6a6258;margin-top:16px}
.slide-label{font-family:'Courier New',monospace;font-size:10px;letter-spacing:0.18em;text-transform:uppercase;color:#9c9085;border-bottom:1.5px solid #e0dbd3;padding-bottom:10px;margin-bottom:20px}
h2{font-family:'Fraunces',serif;font-size:34px;font-weight:700;color:#18140f;letter-spacing:-0.02em;line-height:1.15;margin-bottom:20px}
ul{list-style:none;display:flex;flex-direction:column;gap:10px}
li{font-size:15px;color:#3b3428;display:flex;align-items:flex-start;gap:10px;line-height:1.5}
li::before{content:'→';color:#1e7a5a;font-weight:600;flex-shrink:0;margin-top:1px}
@media print{body{background:white;padding:0}
.slide{page-break-after:always;margin:0;border-radius:0;width:100vw;height:100vh;box-shadow:none}}
</style></head><body>${slides.join('')}</body></html>`;
}

// ── Tool open handlers ────────────────────────────────────────
function handleToolExport(toolId, url, badge) {
  // For copy+open tools: copy content then open the tool
  if (badge === 'copy') {
    const text = currentDoc === 'gantt' ? buildGanttTextSummary() : getPreviewText();
    if (text.trim()) {
      navigator.clipboard.writeText(text).then(() => {
        showToast(`📋 Content copied! Opening ${toolId}…`);
        setTimeout(() => window.open(url, '_blank'), 600);
      }).catch(() => { window.open(url, '_blank'); });
    } else {
      showToast('Fill in some fields first!');
    }
    return;
  }
  // For open tools: just open the URL
  window.open(url, '_blank');
  showToast(`↗ Opening ${toolId}…`);
}

// ── Helpers ───────────────────────────────────────────────────
function downloadFile(filename, content, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function getFilename(ext) {
  const titleEl = document.getElementById('docTitle');
  const raw = titleEl ? titleEl.value.trim() : '';
  const safe = raw.replace(/[^a-z0-9]+/gi, '-').replace(/^-|-$/g, '').toLowerCase() || currentDoc;
  return `${safe}.${ext}`;
}

function getPreviewText() {
  const preview = document.getElementById('previewDoc');
  return preview ? preview.innerText.trim() : '';
}

function buildGanttTextSummary() {
  const titleEl = document.getElementById('docTitle');
  const title = (titleEl ? titleEl.value.trim() : '') || 'Gantt Chart';
  const statusLabels = { notstarted:'Not Started', inprogress:'In Progress', done:'Done', atrisk:'At Risk', blocked:'Blocked' };
  let text = `${title}\n${'─'.repeat(title.length)}\n\n`;
  text += `TASK TIMELINE\n`;
  ganttTasks.forEach(t => {
    text += `• ${t.name||'—'} (${t.owner||'—'}) — Wk ${t.start}, ${t.dur}w — ${statusLabels[t.status]||t.status} — ${t.pct}%\n`;
  });
  text += `\nTimeline: ${ganttWeeks} weeks`;
  return text;
}

function buildPrintHTML(title) {
  const statusLabels = { notstarted:'Not Started', inprogress:'In Progress', done:'Done', atrisk:'At Risk', blocked:'Blocked' };
  let bodyHtml = '';
  if (currentDoc === 'gantt') {
    const author = (document.getElementById('ganttAuthor')||{}).value||'';
    const sd = (document.getElementById('ganttStartDate')||{}).value||'';
    bodyHtml = `<h1>${title}</h1>`;
    if (author||sd) bodyHtml += `<p class="meta">${[author,sd,`${ganttWeeks} weeks`].filter(Boolean).join(' · ')}</p>`;
    bodyHtml += `<h2>TASK TIMELINE</h2><table><thead><tr><th>Task</th><th>Owner</th><th>Start</th><th>Duration</th><th>Status</th><th>%</th></tr></thead><tbody>`;
    ganttTasks.forEach(t => {
      bodyHtml += `<tr><td><strong>${t.name||'—'}</strong></td><td>${t.owner||'—'}</td><td>Wk ${t.start}</td><td>${t.dur}w</td><td>${statusLabels[t.status]||t.status}</td><td>${t.pct}%</td></tr>`;
    });
    bodyHtml += `</tbody></table>`;
  } else {
    const preview = document.getElementById('previewDoc');
    if (preview) {
      const t2 = preview.querySelector('.preview-title-area');
      if (t2) bodyHtml += `<h1>${t2.innerText.trim()}</h1>`;
      const m2 = preview.querySelector('[style*="IBM Plex Mono"]');
      if (m2) bodyHtml += `<p class="meta">${m2.innerText.trim()}</p>`;
      preview.querySelectorAll('.preview-section').forEach(sec => {
        const h = sec.querySelector('.preview-section-title');
        const b = sec.querySelector('.preview-section-body');
        if (h) bodyHtml += `<h2>${h.innerText.trim()}</h2>`;
        if (b) bodyHtml += `<p>${b.innerHTML.replace(/<br\s*\/?>/gi,'<br>').replace(/<[^>]+>/g,'')}</p>`;
      });
    }
  }
  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700&family=Outfit:wght@400;500;600&family=IBM+Plex+Mono:wght@400&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Outfit',sans-serif;background:#fff;color:#18140f;padding:40px 48px;max-width:800px;margin:0 auto}
h1{font-family:'Fraunces',serif;font-size:32px;font-weight:700;letter-spacing:-0.02em;margin-bottom:6px;line-height:1.15}
h2{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.2em;text-transform:uppercase;color:#9c9085;margin:24px 0 6px;padding-bottom:6px;border-bottom:1px solid #e0dbd3}
p{font-size:13.5px;line-height:1.75;color:#3b3428;margin-bottom:4px}
.meta{font-family:'IBM Plex Mono',monospace;font-size:10px;color:#9c9085;margin-bottom:28px;padding-bottom:16px;border-bottom:1.5px solid #e0dbd3;letter-spacing:0.06em}
table{width:100%;border-collapse:collapse;font-size:12px;margin:10px 0}
th{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:0.14em;text-transform:uppercase;color:#9c9085;text-align:left;padding:6px 8px;border-bottom:1.5px solid #e0dbd3}
td{padding:7px 8px;border-bottom:1px solid #e0dbd3;color:#3b3428}
@media print{body{padding:24px 32px}@page{margin:1.5cm}}
</style></head><body>${bodyHtml}</body></html>`;
}

// Clipboard copy
function copyDocument() {
  const text = currentDoc === 'gantt' ? buildGanttTextSummary() : getPreviewText();
  if (!text.trim()) { showToast('Nothing to copy yet — fill in some fields first!'); return; }
  navigator.clipboard.writeText(text).then(() => showToast('✓ Copied to clipboard!'));
}

// Keep syncExportButtons as no-op (modal handles all now)
function syncExportButtons() {}

function clearDoc() {
  switchDoc(currentDoc, null, null);
  showToast('🗑 Document cleared');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ─── SIDEBAR COLLAPSE ─────────────────────────────────────────
function toggleSideSection(btn) {
  const section = btn.closest('.sl-section');
  section.classList.toggle('collapsed');
}

// ─── LEFT SIDEBAR BURGER TOGGLE ───────────────────────────────
let leftOpen = true;
function toggleLeftSidebar() {
  const sidebar = document.querySelector('.sidebar-left');
  const workspace = document.querySelector('.workspace');
  leftOpen = !leftOpen;

  sidebar.classList.toggle('collapsed', !leftOpen);
  updateWorkspaceGrid(workspace);
  // Burger icon NEVER changes — always 3 lines
}

// ─── RIGHT SIDEBAR TOGGLE ─────────────────────────────────────
let rightOpen = true;
function toggleRightSidebar() {
  const sidebar = document.getElementById('sidebarRight');
  const workspace = document.querySelector('.workspace');
  const tab = document.getElementById('rightToggleTab');
  const icon = document.getElementById('rightToggleIcon');
  rightOpen = !rightOpen;

  sidebar.classList.toggle('collapsed', !rightOpen);
  updateWorkspaceGrid(workspace);

  // Tab always stays visible — just moves to right:0 when closed
  if (rightOpen) {
    // Panel is now open: position tab at left edge of sidebar
    tab.classList.remove('panel-closed');
    tab.classList.add('panel-open');
    // Arrow points right (→) to indicate "click to close/collapse"
    icon.innerHTML = `<path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>`;
  } else {
    // Panel is now closed: tab pins to viewport right edge
    tab.classList.remove('panel-open');
    tab.classList.add('panel-closed');
    // Arrow points left (←) to indicate "click to open/expand"
    icon.innerHTML = `<path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>`;
  }
}

function updateWorkspaceGrid(workspace) {
  const sw = leftOpen ? 'var(--sidebar-w)' : '0px';
  const rw = rightOpen ? 'var(--sidebar-w)' : '0px';
  workspace.style.gridTemplateColumns = `${sw} 1fr ${rw}`;
}

// ─── INIT ─────────────────────────────────────────────────────
switchDoc('user-story');
syncExportButtons();
</script>
</body>
</html>
